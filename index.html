
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Hi I'm Justin-lu</title>
    <meta name="author" content="Justin-lu">
    
	<meta name="description" content="Published on: Tags: rails 分享一下自己阅读ActiveSupport::Concern源码的过程，希望和大家一起学习，错误之处，还请指出 在查看ActiveSupport::Concern 源码之前，我们先理解几个概念 class_eval and &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Hi I'm Justin-lu" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.ico" rel="shortcut icon">
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">

    <link href='http://fonts.googleapis.com/css?family=Slackey' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Amethysta' rel='stylesheet' type='text/css'>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

    <script type="text/javascript" src="/javascripts/jquery-tapir.js"></script>

    <!-- remove or comment it to disable ajaxification -->   
    <script src="/javascripts/ajaxify.js"></script>
   
    
    
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-42406282-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</head>


<body>
    <div id="wrapper">
    <header id="header" class="inner"><!-- for more effects see _animate.scss -->
<h1 class="animated bounceInDown">
    <div id="headerbg">
        Justin-lu
    </div>
</h1>
<br>

<ul id="social-links" style="text-align:center">
  
  <!-- GitHub -->
  <li>
  <a href="https://github.com/Justin-lu" class="github" title="Github"></a>
  </li>
  
  
  <!-- Google Plus -->
  <li>
  <a href="http://plus.google.com/Justin-lu?rel=author" class="google" title="Google+"></a>
  </li>
  
  
  
  
  
  
  
  
  <!-- Sina Weibo -->
  <li>
    <a href="http://weibo.com/luxiaoyong17" target="_blank">
      <svg width="40" height="40" class="sina-weibo" version="1.1" xmlns="http://www.w3.org/2000/svg">
        <path fill="" d="M9.641,17.231c-3.799,0.374-7.079-1.343-7.326-3.838c-0.246-2.494,2.634-4.82,6.434-5.196  c3.798-0.377,7.079,1.34,7.326,3.835C16.32,14.529,13.44,16.855,9.641,17.231 M17.24,8.952c-0.322-0.098-0.544-0.163-0.375-0.587  c0.365-0.921,0.403-1.718,0.007-2.286c-0.745-1.063-2.783-1.005-5.12-0.027c0-0.002-0.734,0.321-0.546-0.261  c0.359-1.156,0.305-2.123-0.254-2.682c-1.267-1.271-4.639,0.047-7.53,2.936C1.257,8.209,0,10.504,0,12.488  c0,3.796,4.866,6.104,9.628,6.104c6.241,0,10.393-3.627,10.393-6.506C20.021,10.347,18.557,9.358,17.24,8.952" />
        <path fill="" d="M21.384,2.005c-1.507-1.671-3.73-2.308-5.782-1.872l0,0c-0.475,0.102-0.778,0.569-0.676,1.043  c0.101,0.473,0.567,0.777,1.043,0.674c1.459-0.31,3.039,0.145,4.111,1.332c1.069,1.188,1.362,2.806,0.902,4.225v0.001  c-0.149,0.462,0.104,0.957,0.566,1.106c0.461,0.149,0.956-0.104,1.105-0.565c0,0,0-0.002,0-0.004  C23.299,5.95,22.894,3.674,21.384,2.005" />
        <path fill="" d="M19.07,4.094c-0.734-0.814-1.817-1.123-2.817-0.912c-0.409,0.088-0.671,0.49-0.581,0.899  c0.088,0.407,0.489,0.67,0.896,0.58v0.001c0.488-0.104,1.019,0.047,1.379,0.445c0.359,0.398,0.455,0.941,0.301,1.416l0,0  c-0.127,0.398,0.09,0.825,0.488,0.954c0.396,0.127,0.824-0.091,0.952-0.488C20,6.017,19.805,4.908,19.07,4.094" />
        <path fill="" d="M9.85,12.713c-0.132,0.229-0.426,0.338-0.656,0.242c-0.227-0.094-0.297-0.348-0.169-0.572  c0.132-0.221,0.416-0.328,0.64-0.239C9.895,12.227,9.978,12.483,9.85,12.713 M8.64,14.268c-0.367,0.586-1.154,0.843-1.747,0.57  c-0.584-0.265-0.756-0.945-0.389-1.518c0.362-0.568,1.124-0.824,1.712-0.574C8.811,12.998,9.001,13.675,8.64,14.268 M10.021,10.118  c-1.808-0.47-3.852,0.431-4.637,2.023c-0.8,1.624-0.026,3.428,1.801,4.017c1.892,0.612,4.122-0.324,4.898-2.078  C12.848,12.367,11.891,10.602,10.021,10.118" />
      </svg>
    </a>
  </li>
  
  
  <!-- Tencent Weibo -->
  <li>
    <a href="http://t.qq.com/gdjyluxiaoyong" target="_blank">
      <svg width="40" height="40" class="tencent-weibo" version="1.1" xmlns="http://www.w3.org/2000/svg">
        <circle fill="" cx="8.229" cy="10.478" r="2.543" />
        <path fill="" d="M8.229,18.163c-0.615,0-1.227-0.073-1.82-0.217  c-0.364-0.088-0.587-0.455-0.499-0.819c0.088-0.364,0.455-0.588,0.819-0.5c0.488,0.119,0.993,0.178,1.5,0.178  c3.49,0,6.33-2.839,6.33-6.329c0-3.49-2.839-6.33-6.33-6.33c-3.49,0-6.329,2.84-6.329,6.33c0,1.123,0.297,2.226,0.861,3.189  c0.189,0.323,0.08,0.739-0.243,0.928s-0.739,0.08-0.928-0.243c-0.685-1.172-1.046-2.511-1.046-3.875  c0-4.238,3.448-7.686,7.686-7.686c4.238,0,7.686,3.448,7.686,7.686C15.915,14.716,12.467,18.163,8.229,18.163z" />
        <path fill="" d="M2.066,24.549c-0.277,0-0.51-0.216-0.526-0.496c-0.021-0.351-0.451-8.643,5.989-13.397  c0.234-0.173,0.565-0.124,0.738,0.111c0.173,0.234,0.123,0.565-0.111,0.738C2.186,15.913,2.589,23.909,2.593,23.99  c0.018,0.29-0.204,0.541-0.495,0.558C2.087,24.548,2.077,24.549,2.066,24.549z" />
        <circle fill="" cx="22.443" cy="5.184" r="1.536" />
        <path fill="" d="M26.739,6.946c-0.141,0.344-0.322,0.669-0.538,0.967  c-0.133,0.184-0.389,0.224-0.572,0.091s-0.225-0.389-0.091-0.572c0.178-0.246,0.327-0.514,0.443-0.797  c0.8-1.951-0.136-4.188-2.086-4.988c-1.951-0.8-4.188,0.136-4.988,2.086c-0.8,1.951,0.136,4.188,2.086,4.988  c0.628,0.257,1.312,0.344,1.98,0.25c0.224-0.031,0.431,0.125,0.463,0.349c0.032,0.224-0.125,0.431-0.349,0.463  c-0.812,0.114-1.643,0.009-2.405-0.304c-2.369-0.971-3.505-3.688-2.534-6.057c0.972-2.369,3.688-3.505,6.058-2.534  C26.574,1.86,27.71,4.577,26.739,6.946z" />
        <path fill="" d="M28.895,11.854c-0.063,0.154-0.237,0.234-0.397,0.18c-0.201-0.068-4.934-1.729-6.115-6.419  c-0.043-0.17,0.061-0.343,0.231-0.386c0.171-0.043,0.344,0.06,0.388,0.231c1.095,4.348,5.656,5.956,5.703,5.971  c0.167,0.057,0.255,0.238,0.198,0.404C28.899,11.843,28.897,11.848,28.895,11.854z" />
      </svg>
    </a>
  </li>
  
</ul>


<!-- use full url including 'index.html' for navigation bar if you are using ajax -->
<ul id="nav">
	<li id="ajax"><a href="/index.html">Home</a></li>
	<li id="ajax"><a href="/blog/archives/index.html">Archives</a></li>
    <li id="ajax"><a href="/about-me/index.html">About Me</a></li>
    <li><a href="/atom.xml">RSS</a></li>
    
    <li>
    <div id="dark">
        <form method="get" action="/search.html" id="search">
            <input name="query" type="text" placeholder="Search..." x-webkit-speech />
        </form>
    </div>
    </li>
    
</ul>




</header>

<div id="toload">
<!-- begin toload --> 
    <div id="content" class="inner">
        


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/07/05/li-jie-activesupport-concern/">
		
			理解 ActiveSupport::Concern</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2015-07-05T21:49:00+08:00" pubdate data-updated="true"></time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/rails/'>rails</a>


</div>
    </div>
		<p>分享一下自己阅读ActiveSupport::Concern源码的过程，希望和大家一起学习，错误之处，还请指出</p>

<p>在查看ActiveSupport::Concern <a href="https://github.com/rails/rails/blob/master/activesupport/lib/active_support/concern.rb">源码</a>之前，我们先理解几个概念</p>

<h2>class_eval and instance_eval</h2>

<h3>instance_eval</h3>

<p>首先从名字可以得到的信息是，<code>instance_eval</code>的调用者<code>receiver</code>必须是一个实例<code>instance</code>，而在<code>instance_eval</code> block的内部，self即为receiver实例本身。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># 例子一</span>
</span><span class='line'><span class="n">obj_instance</span><span class="o">.</span><span class="n">instance_eval</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">self</span>  <span class="c1"># =&gt; obj_instance</span>
</span><span class='line'>  <span class="c1"># current class =&gt; obj_instance&#39;s singleton class</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>根据这个定义，如果在一个实例上调用了<code>instance_eval</code>，就可以在其中定义该实例的单态函数<code>singleton_method</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># 例子二</span>
</span><span class='line'><span class="k">class</span> <span class="nc">A</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">a</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">instance_eval</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="nb">self</span>  <span class="c1"># =&gt; a</span>
</span><span class='line'>  <span class="c1"># current class =&gt; a&#39;s singleton class</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">method1</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;this is a singleton method of instance a&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">method1</span>
</span><span class='line'><span class="c1">#=&gt; this is a singleton method of instance a</span>
</span><span class='line'>
</span><span class='line'><span class="n">b</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="n">b</span><span class="o">.</span><span class="n">method1</span>
</span><span class='line'><span class="c1">#=&gt; NoMethodError: undefined method `method1&#39; for #&lt;A:0x007fbc2ced9550&gt;</span>
</span><span class='line'><span class="n">from</span> <span class="p">(</span><span class="n">pry</span><span class="p">):</span><span class="mi">13</span><span class="ss">:in</span> <span class="sb">`&lt;main&gt;&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>如我们所知，因为类本身也是Class类的一个实例，instance_eval也可以用在类上，这个时候就可以在其中定义该类的singleton_method，即为该类的类方法.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># 例子三</span>
</span><span class='line'><span class="k">class</span> <span class="nc">A</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">A</span><span class="o">.</span><span class="n">instance_eval</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="nb">self</span>  <span class="c1"># =&gt; A</span>
</span><span class='line'>  <span class="c1"># current class =&gt; A&#39;s singleton class</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">method1</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s1">&#39;this is a singleton method of class A&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">A</span><span class="o">.</span><span class="n">method1</span>
</span><span class='line'><span class="c1"># this is a singleton method of class A</span>
</span><span class='line'><span class="c1">#=&gt;  nil</span>
</span><span class='line'>
</span><span class='line'><span class="c1">#=&gt; NoMethodError: undefined method `method1&#39; for #&lt;A:0x007fbc3009e180&gt;</span>
</span><span class='line'><span class="n">from</span> <span class="p">(</span><span class="n">pry</span><span class="p">):</span><span class="mi">11</span><span class="ss">:in</span> <span class="sb">`&lt;main&gt;&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>class_eval</h3>

<p>再来看<code>class_eval</code>，首先从名字可以得到的信息是，class_eval的调用者receiver必须是一个类，而在<code>class_eval</code> <code>block</code>的内部，<code>self</code>即为receiver类本身。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># 例子四</span>
</span><span class='line'><span class="k">class</span> <span class="nc">A</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">A</span><span class="o">.</span><span class="n">class_eval</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="nb">self</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="c1"># =&gt; A</span>
</span></code></pre></td></tr></table></div></figure>


<p>根据这个定义，如果在一个类上调用了class_eval，就可以在其中定义该类的实例方法(instance_method)，例如</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># 例子五</span>
</span><span class='line'><span class="k">class</span> <span class="nc">A</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">a</span> <span class="o">=</span> <span class="n">A</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">method1</span>
</span><span class='line'><span class="c1">#=&gt; NoMethodError: undefined method `method1&#39; for &lt;A:0x007fbc29a826f8&gt; from (pry):21:in `&lt;main&gt;&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">A</span><span class="o">.</span><span class="n">class_eval</span> <span class="k">do</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">method1</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s1">&#39;this is a instance method of class A&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">method1</span>
</span><span class='line'><span class="c1">#=&gt; this is a instance method of class A</span>
</span></code></pre></td></tr></table></div></figure>


<p>综合上面例子，我们可得出</p>

<pre><code>1. `instance_eval`必须由instance来调用，可以用来定义单例函数（`singleton_methods`)
2. `class_eval`必须是由class来调用，可以用来定义类的实例方法(`instance_methods`)
</code></pre>

<h2>include and extend</h2>

<p>废话不多说，先看代码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># 例子六</span>
</span><span class='line'><span class="k">module</span> <span class="nn">Foo</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">foo</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s1">&#39;foo method with include...&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Bar</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Foo</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">Bar</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">foo</span>
</span><span class='line'><span class="c1"># foo method with include...</span>
</span><span class='line'><span class="c1"># =&gt; nil</span>
</span><span class='line'><span class="no">Bar</span><span class="o">.</span><span class="n">foo</span>
</span><span class='line'><span class="c1"># NoMethodError: undefined method `foo&#39; for Bar:Class</span>
</span><span class='line'><span class="c1"># from (pry):75:in `&lt;main&gt;&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Baz</span>
</span><span class='line'>  <span class="kp">extend</span> <span class="no">Foo</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">Baz</span><span class="o">.</span><span class="n">foo</span>
</span><span class='line'><span class="c1"># foo method with include...</span>
</span><span class='line'><span class="c1"># =&gt; nil</span>
</span><span class='line'>
</span><span class='line'><span class="no">Baz</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">foo</span>
</span><span class='line'><span class="c1"># NoMethodError: undefined method `foo&#39; for #&lt;Baz:0x007f8061dec068&gt;</span>
</span><span class='line'><span class="c1"># from (pry):80:in `&lt;main&gt;&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>由例子我们可以看出，<code>include</code>会把<code>module</code>的方法变成实例方法，<code>extend</code> 会把方法变成类方法。
但是，大多时候我们也可以用<code>include</code>来实现类方法和实例方法，请看以下例子：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># 例子七</span>
</span><span class='line'><span class="k">module</span> <span class="nn">Foo</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">included</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
</span><span class='line'>    <span class="n">base</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="no">ClassMethods</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">ClassMethods</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">bar</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s1">&#39;class method&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">foo</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s1">&#39;instance method&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Baz</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">Foo</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">Baz</span><span class="o">.</span><span class="n">bar</span>
</span><span class='line'><span class="c1"># class method</span>
</span><span class='line'><span class="c1"># =&gt; nil</span>
</span><span class='line'><span class="no">Baz</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">foo</span>
</span><span class='line'><span class="c1"># instance method</span>
</span><span class='line'><span class="c1"># =&gt; nil</span>
</span><span class='line'><span class="no">Baz</span><span class="o">.</span><span class="n">foo</span>
</span><span class='line'><span class="c1"># NoMethodError: undefined method `foo&#39; for Baz:Class</span>
</span><span class='line'><span class="no">Baz</span><span class="o">.</span><span class="n">new</span><span class="o">.</span><span class="n">bar</span>
</span><span class='line'><span class="c1"># NoMethodError: undefined method `bar&#39; for #&lt;Baz:0x007fbc30274ab8&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<p>从例子我们可以看出，<code>include</code>有一个叫<code>included</code>的钩子，正是通过这个钩子，我们可以用<code>include</code>实现添加类方法和实例方法
我们来看看<code>included</code>这个钩子到底做了什么？</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">module</span> <span class="nn">A</span>
</span><span class='line'>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">included</span><span class="p">(</span><span class="n">mod</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="nb">self</span><span class="si">}</span><span class="s2"> included in </span><span class="si">#{</span><span class="n">mod</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Enumerable</span>
</span><span class='line'>    <span class="kp">include</span> <span class="n">A</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="c1"># A included in Enumerable</span>
</span><span class='line'>  <span class="c1"># =&gt; Enumerable</span>
</span></code></pre></td></tr></table></div></figure>


<p>从代码我们的输出我们可以知道，<code>included</code>类方法作用域<code>self</code>为<code>Module A</code>，并传入<code>include A</code>的<code>receiver Enumerable</code>。然后我们再看看例子七，结合<code>extend</code>与<code>include</code>的理解，就能明白其中的原理所在。</p>

<p>再来看看ActiveSupport::Concern的实现：</p>

<ol>
<li>在没有引入<code>ActiveSupport::Concern</code>之前，我们可以这样进行模块分离</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">module</span> <span class="nn">M</span>
</span><span class='line'>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">included</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
</span><span class='line'>      <span class="n">base</span><span class="o">.</span><span class="n">extend</span> <span class="no">ClassMethods</span>
</span><span class='line'>      <span class="n">base</span><span class="o">.</span><span class="n">class_eval</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">scope</span> <span class="ss">:disabled</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">disabled</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="kp">include</span> <span class="no">InstanceMethods</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">module</span> <span class="nn">ClassMethods</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">say_hello</span>
</span><span class='line'>        <span class="nb">puts</span> <span class="s2">&quot;say hello&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">module</span> <span class="nn">InstanceMethods</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">say_no</span>
</span><span class='line'>        <span class="nb">puts</span> <span class="s2">&quot;say no&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>从代码可知，通过<code>extend</code>和<code>class_eval</code>为<code>base</code>定义了<code>ClassMethods</code>里面的类方法，通过<code>include</code> 为<code>base</code>定义了<code>InstanceMethods</code>里面的实力方法。</p>

<p>当我们引入<code>ActiveSupport::Concern</code>之后，以上例子我们可以这样写:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="nb">require</span> <span class="s1">&#39;active_support/concern&#39;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">M</span>
</span><span class='line'>    <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">included</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">scope</span> <span class="ss">:disabled</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="ss">disabled</span><span class="p">:</span> <span class="kp">true</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="kp">include</span> <span class="no">InstanceMethods</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">module</span> <span class="nn">ClassMethods</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">say_hello</span>
</span><span class='line'>        <span class="nb">puts</span> <span class="s2">&quot;say hello&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">module</span> <span class="nn">InstanceMethods</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">say_no</span>
</span><span class='line'>        <span class="nb">puts</span> <span class="s2">&quot;say no&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>最后，我们再来看看[ActiveSupport::Concern] (<a href="https://github.com/rails/rails/blob/master/activesupport/lib/active_support/concern.rb">https://github.com/rails/rails/blob/master/activesupport/lib/active_support/concern.rb</a>),是不是就很好理解了？</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">Concern</span>
</span><span class='line'>    <span class="k">class</span> <span class="nc">MultipleIncludedBlocks</span> <span class="o">&lt;</span> <span class="no">StandardError</span> <span class="c1">#:nodoc:</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">initialize</span>
</span><span class='line'>        <span class="k">super</span> <span class="s2">&quot;Cannot define multiple &#39;included&#39; blocks for a Concern&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">extended</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="c1">#:nodoc:</span>
</span><span class='line'>      <span class="n">base</span><span class="o">.</span><span class="n">instance_variable_set</span><span class="p">(</span><span class="ss">:@_dependencies</span><span class="p">,</span> <span class="o">[]</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">append_features</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">base</span><span class="o">.</span><span class="n">instance_variable_defined?</span><span class="p">(</span><span class="ss">:@_dependencies</span><span class="p">)</span>
</span><span class='line'>        <span class="n">base</span><span class="o">.</span><span class="n">instance_variable_get</span><span class="p">(</span><span class="ss">:@_dependencies</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
</span><span class='line'>        <span class="k">return</span> <span class="kp">false</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="k">return</span> <span class="kp">false</span> <span class="k">if</span> <span class="n">base</span> <span class="o">&lt;</span> <span class="nb">self</span>
</span><span class='line'>        <span class="vi">@_dependencies</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">dep</span><span class="o">|</span> <span class="n">base</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>        <span class="k">super</span>
</span><span class='line'>        <span class="n">base</span><span class="o">.</span><span class="n">extend</span> <span class="nb">const_get</span><span class="p">(</span><span class="ss">:ClassMethods</span><span class="p">)</span> <span class="k">if</span> <span class="nb">const_defined?</span><span class="p">(</span><span class="ss">:ClassMethods</span><span class="p">)</span>
</span><span class='line'>        <span class="n">base</span><span class="o">.</span><span class="n">class_eval</span><span class="p">(</span><span class="o">&amp;</span><span class="vi">@_included_block</span><span class="p">)</span> <span class="k">if</span> <span class="n">instance_variable_defined?</span><span class="p">(</span><span class="ss">:@_included_block</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">included</span><span class="p">(</span><span class="n">base</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">base</span><span class="o">.</span><span class="n">nil?</span>
</span><span class='line'>        <span class="k">raise</span> <span class="no">MultipleIncludedBlocks</span> <span class="k">if</span> <span class="n">instance_variable_defined?</span><span class="p">(</span><span class="ss">:@_included_block</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="vi">@_included_block</span> <span class="o">=</span> <span class="n">block</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="k">super</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">class_methods</span><span class="p">(</span><span class="o">&amp;</span><span class="n">class_methods_module_definition</span><span class="p">)</span>
</span><span class='line'>      <span class="n">mod</span> <span class="o">=</span> <span class="nb">const_defined?</span><span class="p">(</span><span class="ss">:ClassMethods</span><span class="p">,</span> <span class="kp">false</span><span class="p">)</span> <span class="p">?</span>
</span><span class='line'>        <span class="nb">const_get</span><span class="p">(</span><span class="ss">:ClassMethods</span><span class="p">)</span> <span class="p">:</span>
</span><span class='line'>        <span class="nb">const_set</span><span class="p">(</span><span class="ss">:ClassMethods</span><span class="p">,</span> <span class="no">Module</span><span class="o">.</span><span class="n">new</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">mod</span><span class="o">.</span><span class="n">module_eval</span><span class="p">(</span><span class="o">&amp;</span><span class="n">class_methods_module_definition</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>Rails4.1 之后，Module还加入了<a href="http://api.rubyonrails.org/v4.1.0/classes/Module/Concerning.html">Concerning</a>方法</p>

<h2>Concerning</h2>

<p>我们先来看看细化concern的几种方法</p>

<ul>
<li>通过注释</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Todo</span>
</span><span class='line'>  <span class="c1"># Other todo implementation</span>
</span><span class='line'>  <span class="c1"># ...</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">## Event tracking</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:events</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">before_create</span> <span class="ss">:track_creation</span>
</span><span class='line'>  <span class="n">after_destroy</span> <span class="ss">:track_deletion</span>
</span><span class='line'>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">track_creation</span>
</span><span class='line'>      <span class="c1"># ...</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>通过<code>ActiveSupport::Concern</code></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Todo</span>
</span><span class='line'>  <span class="c1"># Other todo implementation</span>
</span><span class='line'>  <span class="c1"># ...</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">module</span> <span class="nn">EventTracking</span>
</span><span class='line'>    <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">included</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">has_many</span> <span class="ss">:events</span>
</span><span class='line'>      <span class="n">before_create</span> <span class="ss">:track_creation</span>
</span><span class='line'>      <span class="n">after_destroy</span> <span class="ss">:track_deletion</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">private</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">track_creation</span>
</span><span class='line'>        <span class="c1"># ...</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>  <span class="kp">include</span> <span class="no">EventTracking</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>通过<code>concerning</code></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Todo</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="c1"># Other todo implementation</span>
</span><span class='line'>  <span class="c1"># ...</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">concerning</span> <span class="ss">:EventTracking</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">included</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">has_many</span> <span class="ss">:events</span>
</span><span class='line'>      <span class="n">before_create</span> <span class="ss">:track_creation</span>
</span><span class='line'>      <span class="n">after_destroy</span> <span class="ss">:track_deletion</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="kp">private</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">track_creation</span>
</span><span class='line'>        <span class="c1"># ...</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="no">Todo</span><span class="o">.</span><span class="n">ancestors</span>
</span><span class='line'><span class="c1"># [Todo,Todo::EventTracking,...]</span>
</span></code></pre></td></tr></table></div></figure>


<p>总得来说，<code>concerning</code>主要用于切分比较小的model
另外，还有还提供了类似的<code>concern</code>等方法</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">concern</span> <span class="ss">:EventTracking</span> <span class="k">do</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">is</span> <span class="n">equivalent</span> <span class="n">to</span>
</span><span class='line'>
</span><span class='line'><span class="k">module</span> <span class="nn">EventTracking</span>
</span><span class='line'>  <span class="kp">extend</span> <span class="no">ActiveSupport</span><span class="o">::</span><span class="no">Concern</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>最后贴上自用 <a href="https://gist.github.com/Justin-lu/156bd4a1cba1c507e485">sublime snippet</a>,但是我是Vim党.</p>

<p>Reference:
<a href="http://www.railstips.org/blog/archives/2009/05/15/include-vs-extend-in-ruby/">http://www.railstips.org/blog/archives/2009/05/15/include-vs-extend-in-ruby/</a>
<a href="https://github.com/rails/rails/blob/master/activesupport/lib/active_support/concern.rb">https://github.com/rails/rails/blob/master/activesupport/lib/active_support/concern.rb</a>
<a href="https://github.com/rails/rails/blob/master/activesupport/lib/active_support/concern.rb">https://github.com/rails/rails/blob/master/activesupport/lib/active_support/concern.rb</a></p>

<hr />

<p>补充：</p>

<h2>ActiveSupport::Concern#append_features</h2>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">append_features</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">base</span><span class="o">.</span><span class="n">instance_variable_defined?</span><span class="p">(</span><span class="ss">:@_dependencies</span><span class="p">)</span>
</span><span class='line'>    <span class="n">base</span><span class="o">.</span><span class="n">instance_variable_get</span><span class="p">(</span><span class="ss">:@_dependencies</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
</span><span class='line'>    <span class="k">return</span> <span class="kp">false</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="k">return</span> <span class="kp">false</span> <span class="k">if</span> <span class="n">base</span> <span class="o">&lt;</span> <span class="nb">self</span>
</span><span class='line'>    <span class="vi">@_dependencies</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">dep</span><span class="o">|</span> <span class="n">base</span><span class="o">.</span><span class="n">include</span><span class="p">(</span><span class="n">dep</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'>    <span class="k">super</span>
</span><span class='line'>    <span class="n">base</span><span class="o">.</span><span class="n">extend</span> <span class="nb">const_get</span><span class="p">(</span><span class="ss">:ClassMethods</span><span class="p">)</span> <span class="k">if</span> <span class="nb">const_defined?</span><span class="p">(</span><span class="ss">:ClassMethods</span><span class="p">)</span>
</span><span class='line'>    <span class="n">base</span><span class="o">.</span><span class="n">class_eval</span><span class="p">(</span><span class="o">&amp;</span><span class="vi">@_included_block</span><span class="p">)</span> <span class="k">if</span> <span class="n">instance_variable_defined?</span><span class="p">(</span><span class="ss">:@_included_block</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>append_features</code>也是module的一个callback，会在include之后，为当前class添加module的变量，常量，方法等。append_features 会先与included 被调用，详见：<a href="http://apidock.com/ruby/Module/append_features">append_features</a>
上面的代码中，如@neverlandxy_naix所说的一样，正是通过递归的方法处理多重嵌套</p>

<p>首先看到一个<code>if</code>判断,这里判断当前类(base)是否定义了<code>@_dependencies</code>，如果被定义，则把当前module加入<code>@_dependencies</code>。怎么说呢？我们再来看看</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">extended</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="c1">#:nodoc:</span>
</span><span class='line'>  <span class="n">base</span><span class="o">.</span><span class="n">instance_variable_set</span><span class="p">(</span><span class="ss">:@_dependencies</span><span class="p">,</span> <span class="o">[]</span><span class="p">)</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>extended</code>类似于<code>included</code>,具体用法见<a href="http://ruby-doc.org/core-2.2.0/Module.html#method-i-extended">extended</a>
看完<code>extended</code>的用法，我们知道，如果当前类<code>extend</code>了<code>ActiveSupport::Concern</code>,则<code>@_dependencies</code>会被定义。</p>

<p>第二个if判断，判断当前类是否继承于当前模块，如果是，则不需要做其他操作，如果不是，则说明当前类既不是当前模块的子类，也没有<code>extend</code> <code>ActiveSupport::Concern</code>。也就是我们最终要<code>include</code>当前模块的类，此时，当前类<code>include</code>当前模块所有依赖<code>@_dependencies</code>,并定义<code>ClassMethods</code>和<code>included</code>block里面的方法。</p>

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/blog/2015/07/05/li-jie-activesupport-concern//index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/07/05/rails-scopes-yu-jia-zai/">
		
			Rails Scopes 预加载</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2015-07-05T21:48:00+08:00" pubdate data-updated="true"></time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/rails/'>rails</a>


</div>
    </div>
		<p>前几天在<a href="http://rubyweekly.com/">rubyweekly</a>里面看到一篇文章，感觉写得不错。拿出来分享一下。<a href="http://www.justinweiss.com/blog/2015/06/23/how-to-preload-rails-scopes/?utm_source=rubyweekly&amp;utm_medium=email">原文</a>更精彩</p>

<h1>scope 会造成N+1查询</h1>

<p>作为一个Rails开发者，我们经常使用<a href="http://guides.rubyonrails.org/active_record_querying.html#scopes">scope</a>来做查询，以简化你的代码，如：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Review</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:restaurant</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">scope</span> <span class="ss">:positive</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="s2">&quot;rating &gt; 3.0&quot;</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">irb</span><span class="p">(</span><span class="n">main</span><span class="p">):</span><span class="mo">001</span><span class="p">:</span><span class="mi">0</span><span class="o">&gt;</span> <span class="no">Restaurant</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">reviews</span><span class="o">.</span><span class="n">positive</span><span class="o">.</span><span class="n">count</span>
</span><span class='line'>  <span class="no">Restaurant</span> <span class="no">Load</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">4</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span>  <span class="sb">`restaurants`</span><span class="o">.</span><span class="n">*</span> <span class="no">FROM</span> <span class="sb">`restaurants`</span>  <span class="no">ORDER</span> <span class="no">BY</span> <span class="sb">`restaurants`</span><span class="o">.</span><span class="n">`</span><span class="nb">id</span><span class="sb">` ASC LIMIT 1</span>
</span><span class='line'><span class="sb">   (0.6ms)  SELECT COUNT(*) FROM `</span><span class="n">reviews</span><span class="sb">` WHERE `</span><span class="n">reviews</span><span class="sb">`.`</span><span class="n">restaurant_id</span><span class="sb">` = 1 AND (rating &gt; 3.0)</span>
</span><span class='line'><span class="sb">=&gt; 5</span>
</span></code></pre></td></tr></table></div></figure>


<p>但是，当你一不小心，这将严重的影响你应用的性能。
为什么呢？因为使用<code>scope</code>进行定义的查询并不会被预加载。
假设你要查询一些<code>restaurants</code>所有<code>positive reviews</code>：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">irb</span><span class="p">(</span><span class="n">main</span><span class="p">):</span><span class="mo">001</span><span class="p">:</span><span class="mi">0</span><span class="o">&gt;</span> <span class="n">restauraunts</span> <span class="o">=</span> <span class="no">Restaurant</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span class='line'><span class="n">irb</span><span class="p">(</span><span class="n">main</span><span class="p">):</span><span class="mo">002</span><span class="p">:</span><span class="mi">0</span><span class="o">&gt;</span> <span class="n">restauraunts</span><span class="o">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">restaurant</span><span class="o">|</span>
</span><span class='line'><span class="n">irb</span><span class="p">(</span><span class="n">main</span><span class="p">):</span><span class="mo">003</span><span class="p">:</span><span class="mi">1</span><span class="o">*</span>   <span class="s2">&quot;</span><span class="si">#{</span><span class="n">restaurant</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">: </span><span class="si">#{</span><span class="n">restaurant</span><span class="o">.</span><span class="n">reviews</span><span class="o">.</span><span class="n">positive</span><span class="o">.</span><span class="n">length</span><span class="si">}</span><span class="s2"> positive reviews.&quot;</span>
</span><span class='line'><span class="n">irb</span><span class="p">(</span><span class="n">main</span><span class="p">):</span><span class="mo">004</span><span class="p">:</span><span class="mi">1</span><span class="o">&gt;</span> <span class="k">end</span>
</span><span class='line'>  <span class="no">Review</span> <span class="no">Load</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">6</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span> <span class="sb">`reviews`</span><span class="o">.</span><span class="n">*</span> <span class="no">FROM</span> <span class="sb">`reviews`</span> <span class="no">WHERE</span> <span class="sb">`reviews`</span><span class="o">.</span><span class="n">`restaurant_id</span><span class="sb">` = 1 AND (rating &gt; 3.0)</span>
</span><span class='line'><span class="sb">  Review Load (0.5ms)  SELECT `</span><span class="n">reviews</span><span class="sb">`.* FROM `</span><span class="n">reviews</span><span class="sb">` WHERE `</span><span class="n">reviews</span><span class="sb">`.`</span><span class="n">restaurant_id</span><span class="sb">` = 2 AND (rating &gt; 3.0)</span>
</span><span class='line'><span class="sb">  Review Load (0.7ms)  SELECT `</span><span class="n">reviews</span><span class="sb">`.* FROM `</span><span class="n">reviews</span><span class="sb">` WHERE `</span><span class="n">reviews</span><span class="sb">`.`</span><span class="n">restaurant_id</span><span class="sb">` = 3 AND (rating &gt; 3.0)</span>
</span><span class='line'><span class="sb">  Review Load (0.7ms)  SELECT `</span><span class="n">reviews</span><span class="sb">`.* FROM `</span><span class="n">reviews</span><span class="sb">` WHERE `</span><span class="n">reviews</span><span class="sb">`.`</span><span class="n">restaurant_id</span><span class="sb">` = 4 AND (rating &gt; 3.0)</span>
</span><span class='line'><span class="sb">  Review Load (0.7ms)  SELECT `</span><span class="n">reviews</span><span class="sb">`.* FROM `</span><span class="n">reviews</span><span class="sb">` WHERE `</span><span class="n">reviews</span><span class="sb">`.`</span><span class="n">restaurant_id</span><span class="sb">` = 5 AND (rating &gt; 3.0)</span>
</span><span class='line'><span class="sb">=&gt; [&quot;Judd&#39;s Pub: 5 positive reviews.&quot;, &quot;Felix&#39;s Nightclub: 6 positive reviews.&quot;, &quot;Mabel&#39;s Burrito Shack: 7 positive reviews.&quot;, &quot;Kendall&#39;s Burrito Shack: 2 positive reviews.&quot;, &quot;Elisabeth&#39;s Deli: 15 positive reviews.&quot;]</span>
</span></code></pre></td></tr></table></div></figure>


<p>我们可以看到，<code>scope:positive</code>并没有被缓存起来，这明显的是一个<code>N+1</code>查询。</p>

<h1>用associations代替scopes</h1>

<p>我们可以通过用associations代替scopes，来避免这个问题。请看下面例子：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Restaurant</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:reviews</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>当我们查看这个<a href="http://api.rubyonrails.org/classes/ActiveRecord/Associations/ClassMethods.html">文档</a>时,我们可以看到，<code>has_many</code>允许我们添加自定义查询</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Restaurant</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:reviews</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:positive_reviews</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="s2">&quot;rating &gt; 3.0&quot;</span><span class="p">)</span> <span class="p">},</span> <span class="ss">class_name</span><span class="p">:</span> <span class="s2">&quot;Review&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>但我们可以这样子获取一个<code>restaurant</code>的所有<code>positive_reviews</code></p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">irb</span><span class="p">(</span><span class="n">main</span><span class="p">):</span><span class="mo">001</span><span class="p">:</span><span class="mi">0</span><span class="o">&gt;</span> <span class="no">Restaurant</span><span class="o">.</span><span class="n">first</span><span class="o">.</span><span class="n">positive_reviews</span><span class="o">.</span><span class="n">count</span>
</span><span class='line'>  <span class="no">Restaurant</span> <span class="no">Load</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">2</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span>  <span class="sb">`restaurants`</span><span class="o">.</span><span class="n">*</span> <span class="no">FROM</span> <span class="sb">`restaurants`</span>  <span class="no">ORDER</span> <span class="no">BY</span> <span class="sb">`restaurants`</span><span class="o">.</span><span class="n">`</span><span class="nb">id</span><span class="sb">` ASC LIMIT 1</span>
</span><span class='line'><span class="sb">   (0.4ms)  SELECT COUNT(*) FROM `</span><span class="n">reviews</span><span class="sb">` WHERE `</span><span class="n">reviews</span><span class="sb">`.`</span><span class="n">restaurant_id</span><span class="sb">` = 1 AND (rating &gt; 3.0)</span>
</span><span class='line'><span class="sb">=&gt; 5</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后我们就可以通过<code>include</code>来预加载这个关联关系了</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">irb</span><span class="p">(</span><span class="n">main</span><span class="p">):</span><span class="mo">001</span><span class="p">:</span><span class="mi">0</span><span class="o">&gt;</span> <span class="n">restauraunts</span> <span class="o">=</span> <span class="no">Restaurant</span><span class="o">.</span><span class="n">includes</span><span class="p">(</span><span class="ss">:positive_reviews</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span><span class='line'>  <span class="no">Restaurant</span> <span class="no">Load</span> <span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">3</span><span class="n">ms</span><span class="p">)</span>  <span class="no">SELECT</span>  <span class="sb">`restaurants`</span><span class="o">.</span><span class="n">*</span> <span class="no">FROM</span> <span class="sb">`restaurants`</span>  <span class="no">ORDER</span> <span class="no">BY</span> <span class="sb">`restaurants`</span><span class="o">.</span><span class="n">`</span><span class="nb">id</span><span class="sb">` ASC LIMIT 5</span>
</span><span class='line'><span class="sb">  Review Load (1.2ms)  SELECT `</span><span class="n">reviews</span><span class="sb">`.* FROM `</span><span class="n">reviews</span><span class="sb">` WHERE (rating &gt; 3.0) AND `</span><span class="n">reviews</span><span class="sb">`.`</span><span class="n">restaurant_id</span><span class="sb">` IN (1, 2, 3, 4, 5)</span>
</span><span class='line'><span class="sb">irb(main):002:0&gt; restauraunts.map do |restaurant|</span>
</span><span class='line'><span class="sb">irb(main):003:1*   &quot;</span><span class="si">#{</span><span class="n">restaurant</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="sb">: </span><span class="si">#{</span><span class="n">restaurant</span><span class="o">.</span><span class="n">positive_reviews</span><span class="o">.</span><span class="n">length</span><span class="si">}</span><span class="sb"> positive reviews.&quot;</span>
</span><span class='line'><span class="sb">irb(main):004:1&gt; end</span>
</span><span class='line'><span class="sb">=&gt; [&quot;Judd&#39;s Pub: 5 positive reviews.&quot;, &quot;Felix&#39;s Nightclub: 6 positive reviews.&quot;, &quot;Mabel&#39;s Burrito Shack: 7 positive reviews.&quot;, &quot;Kendall&#39;s Burrito Shack: 2 positive reviews.&quot;, &quot;Elisabeth&#39;s Deli: 15 positive reviews.&quot;]</span>
</span></code></pre></td></tr></table></div></figure>


<p>至此，6个Sql查询变成2个</p>

<h1>消除重复</h1>

<p>现在我们定义了一个<code>scope:positive</code>和一个关系<code>has_many :positive_reviews</code>，我们可以看到，它们是重复的。我们可以简单的消除这个DRY.</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">Review</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">belongs_to</span> <span class="ss">:restaurant</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">scope</span> <span class="ss">:positive</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">where</span><span class="p">(</span><span class="s2">&quot;rating &gt; 3.0&quot;</span><span class="p">)</span> <span class="p">}</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Restaurant</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:reviews</span>
</span><span class='line'>  <span class="n">has_many</span> <span class="ss">:positive_reviews</span><span class="p">,</span> <span class="o">-&gt;</span> <span class="p">{</span> <span class="n">positive</span> <span class="p">},</span> <span class="ss">class_name</span><span class="p">:</span> <span class="s2">&quot;Review&quot;</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>至此，我们可以知道<code>scope</code>虽然好用，但是当你发现的代码出现以上问题时，简单的修改，能减少许多<code>sql</code>查询</p>

<p>文章没有逐字翻译，如有问题，麻烦指出。</p>

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/blog/2015/07/05/rails-scopes-yu-jia-zai//index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/05/30/oauth2-dot-0-shi-yong-ji-qiao/">
		
			Oauth2.0</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2014-05-30T15:13:00+08:00" pubdate data-updated="true"></time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/ouath2-dot-0/'>ouath2.0</a>


</div>
    </div>
		<h1>Oauth 2.0</h1>

<ol>
<li><p>client 获取 provider 提供的资源</p></li>
<li><p>流程:</p></li>
</ol>


<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>+----------+
</span><span class='line'>| Resource |
</span><span class='line'>|   Owner  |
</span><span class='line'>|          |
</span><span class='line'>+----------+
</span><span class='line'>     ^
</span><span class='line'>     |
</span><span class='line'>    (B)
</span><span class='line'>+----|-----+          Client Identifier      +---------------+
</span><span class='line'>|         -+----(A)-- & Redirection URI ----&gt;|               |
</span><span class='line'>|  User-   |                                 | Authorization |
</span><span class='line'>|  Agent  -+----(B)-- User authenticates ---&gt;|     Server    |
</span><span class='line'>|          |                                 |               |
</span><span class='line'>|         -+----(C)-- Authorization Code ---&lt;|               |
</span><span class='line'>+-|----|---+                                 +---------------+
</span><span class='line'>  |    |                                         ^      v
</span><span class='line'> (A)  (C)                                        |      |
</span><span class='line'>  |    |                                         |      |
</span><span class='line'>  ^    v                                         |      |
</span><span class='line'>+---------+                                      |      |
</span><span class='line'>|         |&gt;---(D)-- Authorization Code ---------'      |
</span><span class='line'>|  Client |          & Redirection URI                  |
</span><span class='line'>|         |                                             |
</span><span class='line'>|         |&lt;---(E)----- Access Token -------------------'
</span><span class='line'>+---------+       ( Optional Refresh Token)</span></code></pre></td></tr></table></div></figure>


<p>A）用户访问客户端，后者将前者导向认证服务器。
B）用户选择是否给予客户端授权。
C）假设用户给予授权，认证服务器将用户导向客户端事先指定的"重定向URI"（redirection URI），同时附上一个授权码。
D）客户端收到授权码，附上早先的"重定向URI"，向认证服务器申请令牌。这一步是在客户端的后台的服务器上完成的，对用户不可见。
E）认证服务器核对了授权码和重定向URI，确认无误后，向客户端发送访问令牌（access token）和更新令牌（refresh token）。</p>

<ol>
<li>Resource Owner -> devise</li>
<li>API -> Grape</li>
<li>Provider -> doorkeeper</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="n">doorkeeper_for</span> <span class="ss">:all</span>                 <span class="c1"># Require access token for all actions</span>
</span><span class='line'>  <span class="n">doorkeeper_for</span> <span class="ss">:all</span><span class="p">,</span> <span class="ss">except</span><span class="p">:</span> <span class="ss">:index</span> <span class="c1"># All actions except index</span>
</span><span class='line'>  <span class="n">doorkeeper_for</span> <span class="ss">:index</span><span class="p">,</span> <span class="ss">:show</span>        <span class="c1"># Only for index and show action</span>
</span><span class='line'>  <span class="n">doorkeeper_for</span> <span class="ss">:create</span><span class="p">,</span> <span class="ss">:scopes</span> <span class="o">=&gt;</span> <span class="o">[</span><span class="ss">:write</span><span class="o">]</span> <span class="c1">#Only for create action and writable</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li>client</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">module</span> <span class="nn">OmniAuth</span>
</span><span class='line'>  <span class="k">module</span> <span class="nn">Strategies</span>
</span><span class='line'>    <span class="k">class</span> <span class="nc">Doorkeeper</span> <span class="o">&lt;</span> <span class="no">OmniAuth</span><span class="o">::</span><span class="no">Strategies</span><span class="o">::</span><span class="no">OAuth2</span>
</span><span class='line'>      <span class="n">option</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">:doorkeeper</span>
</span><span class='line'>      <span class="n">option</span> <span class="ss">:client_options</span><span class="p">,</span> <span class="p">{</span>
</span><span class='line'>        <span class="ss">:site</span> <span class="o">=&gt;</span> <span class="s2">&quot;http://localhost:8090/&quot;</span><span class="p">,</span>
</span><span class='line'>        <span class="ss">:authorize_path</span> <span class="o">=&gt;</span> <span class="s2">&quot;/oauth/authorize&quot;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="n">uid</span> <span class="k">do</span>
</span><span class='line'>        <span class="n">raw_info</span><span class="o">[</span><span class="s2">&quot;id&quot;</span><span class="o">]</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="n">info</span> <span class="k">do</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>          <span class="ss">:email</span> <span class="o">=&gt;</span> <span class="n">raw_info</span><span class="o">[</span><span class="s2">&quot;email&quot;</span><span class="o">]</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>      <span class="k">def</span> <span class="nf">raw_info</span>
</span><span class='line'>        <span class="vi">@raw_info</span> <span class="o">||=</span> <span class="n">access_token</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;/api/v1/me.json&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">parsed</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>生成client和access_token</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="c1"># get or create an client with OAuth2</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">doorkeeper_oauth_client</span>
</span><span class='line'>    <span class="vi">@client</span> <span class="o">||=</span> <span class="no">OAuth2</span><span class="o">::</span><span class="no">Client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">DOORKEEPER_APP_ID</span><span class="p">,</span> <span class="no">DOORKEEPER_APP_SECRET</span><span class="p">,</span> <span class="ss">:site</span> <span class="o">=&gt;</span> <span class="no">DOORKEEPER_APP_URL</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># get or create an AccessToken</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">doorkeeper_access_token</span>
</span><span class='line'>    <span class="vi">@token</span> <span class="o">||=</span> <span class="no">OAuth2</span><span class="o">::</span><span class="no">AccessToken</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">doorkeeper_oauth_client</span><span class="p">,</span> <span class="n">current_user</span><span class="o">.</span><span class="n">doorkeeper_access_token</span><span class="p">)</span> <span class="k">if</span> <span class="n">current_user</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>通过<code>access_token</code>来获取api数据</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'>  <span class="k">def</span> <span class="nf">index</span>
</span><span class='line'>    <span class="vi">@order</span> <span class="o">=</span> <span class="n">doorkeeper_access_token</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/api/v1/orders&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">parsed</span>
</span><span class='line'>  <span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>




		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/blog/2014/05/30/oauth2-dot-0-shi-yong-ji-qiao//index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2013/10/27/rang-zshwei-ni-de-terminaldai-lai-bu-%5B%3F%5D-yang-de-gan-jue/">
		
			让zsh为你的Terminal带来不一样的感觉</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2013-10-27T15:28:00+08:00" pubdate data-updated="true"></time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/mac/'>mac</a>


</div>
    </div>
		<blockquote><p>使用Git并且在多个分支下开发的同学可能知道，当我们老是在不同分支下切换的时候，有时候会忘记自己在哪个分支，导致我们提交的内容混乱，以前在Ubuntu下，是直接修改<code>.bashrc</code>，让其显示分支名称
本打算用同样的方法修改OS X系统，让其显示分支名，却让我发现了Zsh</p></blockquote>

<hr />

<h2>使用<code>oh-my-zsh</code></h2>

<h3>使用<code>oh-my-zsh</code>的优点</h3>

<ul>
<li>各种补全

<ul>
<li>目录补全可以只输入目录的中间部分进行补全</li>
<li>命令可以补全参数,并且可以显示参数对应的说明</li>
</ul>
</li>
<li>各种主题</li>
<li>目录切换:

<ul>
<li>d : 显示最近使用过的几个目录,按1-9可以直接切换过去</li>
<li>1-9 : 切换至最近使用过的前n个目录</li>
<li>.. 等于 cd ..</li>
<li>… 等于 cd ../..</li>
<li>mcd xxx 等于 mkdir xxx &amp; cd xxx</li>
<li>使用~xxx快捷目录来通过 cd ~xxx 甚至是 ~xxx 快速进入对应的目录</li>
</ul>
</li>
<li>各种插件:

<ul>
<li>extract 直接extract filename ,支持各种tar.gz, bz2, 7z等各种压缩格式</li>
<li>terminalapp 让OS X Lion下的Terminal 启动时打开上次的目录</li>
</ul>
</li>
<li>osx

<ul>
<li>pfd 打印finder的当前路径</li>
<li>cdf cd到finder的当前路径</li>
<li>pushdf pushd 到finder的当前路径</li>
</ul>
</li>
</ul>


<h3>安装<code>oh-my-zsh</code></h3>

<h4>自动安装：</h4>

<blockquote><p>当然，如果你信任这个开源项目作者的话你可以尝试使用自动安装的方法。</p></blockquote>

<p><code>wget https://github.com/robbyrussell/oh-my-zsh/raw/master/tools/install.sh -O - | sh</code></p>

<h4>手动安装：</h4>

<ul>
<li>克隆这个项目到本地(前提是你得有装git)</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">git</span> <span class="nb">clone</span> <span class="ss">git</span><span class="p">:</span><span class="sr">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">robbyrussell</span><span class="o">/</span><span class="n">oh</span><span class="o">-</span><span class="n">my</span><span class="o">-</span><span class="n">zsh</span><span class="o">.</span><span class="n">git</span> <span class="o">~</span><span class="sr">/.oh-my-zsh</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>创建一个zsh的配置文件
注意:如果你已经有一个~/.zshrc文件的话，建议你先做备份。使用以下命令</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">cp</span> <span class="o">~</span><span class="sr">/.zshrc ~/</span><span class="o">.</span><span class="n">zshrc</span><span class="o">.</span><span class="n">orig</span>
</span></code></pre></td></tr></table></div></figure>


<p>然后开始创建zsh的配置文件</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">cp</span> <span class="o">~</span><span class="sr">/.oh-my-zsh/</span><span class="n">templates</span><span class="o">/</span><span class="n">zshrc</span><span class="o">.</span><span class="n">zsh</span><span class="o">-</span><span class="n">template</span> <span class="o">~</span><span class="sr">/.zshrc</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>设置zsh为你的默认的shell</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">chsh</span> <span class="o">-</span><span class="n">s</span> <span class="sr">/bin/</span><span class="n">zsh</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>因为zsh和bash是兼容的，所以，你可以把你<code>.bashrc</code>或者<code>.bashrc_profile</code>里面的内容直接黏贴到<code>.zshrc</code>里面</p></blockquote>

<ul>
<li><a href="https://github.com/robbyrussell/oh-my-zsh">github网址</a></li>
<li><a href="https://github.com/robbyrussell/oh-my-zsh/wiki/themes">各种主题</a></li>
</ul>


<h4>可能遇到的问题</h4>

<blockquote><p>习惯了<code>UTF-8</code>编码的同学，可能需要在<code>.zshrc</code>里面添加如下代码：</p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">export</span> <span class="no">LANG</span><span class="o">=</span><span class="n">en_US</span><span class="o">.</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span> <span class="n">export</span> <span class="no">LC_ALL</span><span class="o">=</span><span class="n">en_US</span><span class="o">.</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/blog/2013/10/27/rang-zshwei-ni-de-terminaldai-lai-bu-%5B%3F%5D-yang-de-gan-jue//index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2013/10/26/cong-vimdao-sublime-text/">
		
			从Vim到Sublime Text</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2013-10-26T19:32:00+08:00" pubdate data-updated="true"></time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/sublime/'>sublime</a>, <a class='category' href='/blog/categories/text/'>text</a>


</div>
    </div>
		<h3>为什么选择Sublime Text</h3>

<blockquote><p>使用Gvim已经三年了，一直很喜欢Vim里面的hjkl等快捷键和多种模式，以致于在Chrome上安装Vimium插件，让我能够永远的脱离鼠标，很喜欢这种感觉。
但是，最近，由于工作需要，在Mac上进行开发，于是装上了MacVim，但是，以前一直用的好好地Vim出现bug了，无法直接双击打开文件（后来发下在终端下打开gvim就可以）加上之前一直听师兄说Sublime Text很好用，所以，我试着Google些资料，然后开始各种尝试&hellip;</p></blockquote>

<h3>Sublime Text 下开启Vim模式</h3>

<blockquote><p>对于一个习惯了Vim操作方式的程序员，这无疑是一个很好的消息，一下是配置方式</p></blockquote>

<ul>
<li>按下<code>Shift + Command + P</code>,调出命令面板</li>
<li>输入<code>setting user</code>,打开用户配置文件</li>
<li>如果之前对配置过，此时应该是一个空文件，把一下代码贴入</li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="s2">&quot;ignored_packages&quot;</span><span class="o">:</span> <span class="p">[]</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>保存这个文件，按下ESC键，这时候，你熟悉的Vim命令就回来啦&hellip;</li>
</ul>


<h3>最新版Sublime Text 3 ,点击<a href="http://www.sublimetext.com/3">这里</a>下载</h3>

<h3>Sublime Text 常用快捷键</h3>

<h4>打开/前往</h4>

<ul>
<li>⌘T   前往文件(和⌘P一样）</li>
<li>⌘⌃P  前往项目</li>
<li>⌘R   前往 method(markdown下，跳转至标题)</li>
<li>⌘⇧P  命令提示</li>
<li>⌃G   前往行</li>
<li>⌘KB  开关侧栏</li>
<li>⌃ `  python 控制台</li>
<li>⌘⇧N  新建窗口</li>
</ul>


<h4>编辑(会用Vim的同学，可以开启Vim模式，和以前一样)</h4>

<ul>
<li>⌘L   选择行 (重复按下将下一行加入选择)</li>
<li>⌘D   选择词 (重复按下时多重选择相同的词进行多重编辑)</li>
<li>⌃⇧M  选择括号内的内容</li>
<li>⌘⇧↩  在当前行前插入新行</li>
<li>⌘↩   在当前行后插入新行</li>
<li>⌃⇧K  删除行</li>
<li>⌘KK  从光标处删除至行尾</li>
<li>⌘K⌫  从光标处删除至行首</li>
<li>⌘⇧D  复制(多)行</li>
<li>⌘J   合并(多)行</li>
<li>⌘KU  改为大写</li>
<li>⌘KL  改为小写</li>
<li>⌘ /  注释</li>
<li>⌘⌥ /   块注释</li>
<li>⌘Y   恢复或重复</li>
<li>⌘⇧V  粘贴并自动缩进</li>
<li>⌃ space  自动完成(重复按下选择下一个提示)</li>
<li>⌃M   跳转至对应的括号</li>
<li>⌘U   软撤销（可撤销光标移动）</li>
<li>⌘⇧U  软重做（可重做光标移动）</li>
</ul>


<h4>XML/HTML</h4>

<ul>
<li>⌘⇧A  选择标签内的内容</li>
<li>⌘⌥ .   闭合当前标签</li>
</ul>


<h4>查找/替换</h4>

<ul>
<li>⌘F   查找</li>
<li>⌘⌥F  替换</li>
<li>⌘⌥G  查找下一个符合当前所选的内容</li>
<li>⌘⌃G  查找所有符合当前所选的内容进行多重编辑</li>
<li>⌘⇧F  在所有打开的文件中进行查找</li>
</ul>


<h4>拆分窗口/标签页</h4>

<ul>
<li>⌘⌥1  单列</li>
<li>⌘⌥2  双列</li>
<li>⌘⌥5  网格 (4组)</li>
<li>⌃[1,2,3,4]   焦点移动至相应组</li>
<li>⌃⇧[1,2,3,4]  将当前文件移动至相应组</li>
<li>⌘[1,2,3…]  选择相应标签页</li>
</ul>


<h4>书签</h4>

<ul>
<li>⌘F2  添加/去除书签</li>
<li>F2   下一个书签</li>
<li>⇧F2  前一个书签</li>
<li>⌘⇧F2   清除书签</li>
</ul>


<h4>标记</h4>

<ul>
<li>⌘K space   设置标记</li>
<li>⌘KW  从光标位置删除至标记</li>
<li>⌘KA  从光标位置选择至标记</li>
<li>⌘KG  清除标记</li>
</ul>


<hr />

<blockquote><blockquote><p>你也可以通过按住<code>command+shift+p</code>,输入<code>keybinding user</code>，往里面添加自定义快捷键。例如：</p></blockquote></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">[</span>
</span><span class='line'>    <span class="p">{</span> <span class="s2">&quot;keys&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;ctrl+alt+p&quot;</span><span class="p">],</span> <span class="s2">&quot;command&quot;</span><span class="o">:</span> <span class="s2">&quot;markdown_preview&quot;</span><span class="p">,</span> <span class="s2">&quot;args&quot;</span><span class="o">:</span> <span class="p">{</span> <span class="s2">&quot;target&quot;</span><span class="o">:</span> <span class="s2">&quot;browser&quot;</span><span class="p">}</span> <span class="p">}</span>
</span><span class='line'><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<h3>安装包控制(Package Control)</h3>

<blockquote><p>我么可以通过Sublime Package Control来进行插件的安装，卸载，升级
安装方法如下：</p>

<blockquote><ol>
<li>打开Sublime Text ，按住 ctrl + `，打开Console，通常这个快捷加可能会冲突，需要重新修改</li>
<li>将以下代码粘贴至控制台</li>
</ol>
</blockquote></blockquote>

<p>  import urllib.request,os; pf = &lsquo;Package Control.sublime-package&rsquo;; ipp = sublime.installed_packages_path(); urllib.request.install_opener( urllib.request.build_opener( urllib.request.ProxyHandler()) ); open(os.path.join(ipp, pf), &lsquo;wb&rsquo;).write(urllib.request.urlopen( &lsquo;<a href="http://sublime.wbond.net/">http://sublime.wbond.net/</a>&rsquo; + pf.replace(&lsquo; &rsquo;,&lsquo;%20&rsquo;)).read())</p>

<blockquote><blockquote><ol>
<li>重启Sbulime,如果在Preferences -> Package Settings中见到Package Control这一项，就说明安装成功了。

<h3>Sublime Text 常用插件</h3>

<h4>MarkdownEditing</h4>

<p>如果安装了 Package Control，可以通过添加 repository，输入<code>http://github.com/ttscoff/MarkdownEditing</code> 然后在 Install Package 里找到 MarkdownEditing。
当然也可以手动 Clone 这个 repo 到 ~/Library/Application Support/Sublime Text 3/Packages。</p></li>
</ol>
</blockquote>

<p>MarkdownEditing 从视觉和便捷性上针对 Markdown 文档的编辑进行了一系列的优化</p></blockquote>

<pre><code>*  安装后针对 md\mdown\mmd\txt 格式文件启用插件。颜色方案仿 Byword 及 iA writer。
*  自动匹配星号（*）、下划线（_）及反引号（`），选中文本按下以上符号能自动在所选文本前后添加配对的符号，方便粗体、斜体和代码框的输入。
*  直接输入配对的符号后按下退格键（backspace），则两个符号都会被删除；直接输入配对的符号后按下空格键，则会自动删除后一个。
*  对“选中文字后输入左括号”这一动作进行了调整，以便插入 markdown 链接。
*  拷贝一个链接，选中文本后按下 ⌘⌥V 会自动插入内联链接。
*  拷贝一个链接，选中文本后按下 ⌘⌥R 会自动插入引用链接。
*  ⌘K 插入链接；⌘⇧K 插入图片。
*  ⌘B 和 ⌘I 分别用于加粗体和斜体。
*  选中文本后按下 # 会自动在文本前后进行配对，可重复按下来定义标题级别，还可用 ⌘⇧空格 来增加 # 与所选文本之间的空格（也是自动配对的）。
</code></pre>

<blockquote><p>有些快捷键可能与系统的一些发生冲突，可以跟之前一样，通过修改自定义快捷键文件</p></blockquote>

<h4>JsFormat</h4>

<blockquote><p>功能类似之前Vim使用的Js beautiful插件，美化你的Js代码，可以通过Package Control 直接安装。按住<code>shift + cmd + p</code>输入js format可以对js文件进行美化。</p></blockquote>

<h4>Git</h4>

<blockquote><p>你可以通过按住<code>shift + cmd + p</code>然后输入几乎所有<code>git</code>命令,个人很喜欢里面的<code>git blame</code>命令,在当前文件下，输入<code>git blame</code>命令后，会打开一个文件,直接看到当前文件的修改内容，这些是谁修改的就一清二楚啦&hellip;</p></blockquote>

<h4>Alignment</h4>

<blockquote><p>这个插件对于有强迫症的同学，简直就是福音啊。例如一下代码</p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">clothPartInfoGrid</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">createGridPanel</span><span class="p">();</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">yarnGrid</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">createYarnGrid</span><span class="p">();</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">indexPanel</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">createIndexPanel</span><span class="p">();</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">mainPanel</span> <span class="o">=</span>  <span class="k">this</span><span class="p">.</span><span class="nx">createMainPanel</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>简单通过选择，<code>ctrl+command+a</code>,即可美化</p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">clothPartInfoGrid</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">createGridPanel</span><span class="p">();</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">yarnGrid</span>          <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">createYarnGrid</span><span class="p">();</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">indexPanel</span>        <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">createIndexPanel</span><span class="p">();</span>
</span><span class='line'>  <span class="k">this</span><span class="p">.</span><span class="nx">mainPanel</span>         <span class="o">=</span>  <span class="k">this</span><span class="p">.</span><span class="nx">createMainPanel</span><span class="p">();</span>
</span></code></pre></td></tr></table></div></figure>


<h3>为Sublime Text 添加主题</h3>

<blockquote><p>可以通过Package Control 安装搜索,按住<code>cmd+shift+p</code>,输入<code>install package</code>,然后输入相应主题名，然后在<code>user setting</code>那里激活主题</p></blockquote>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="s2">&quot;color_scheme&quot;</span><span class="o">:</span> <span class="s2">&quot;Packages/Theme - Flatland/Flatland Dark.tmTheme&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;theme&quot;</span><span class="o">:</span> <span class="s2">&quot;Flatland Dark.sublime-theme&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><a href="http://www.masnun.com/2013/07/08/beautiful-themes-for-sublime-text-3.html">推荐主题列表</a></p>

<h3>Sublime Text 小技巧</h3>

<ol>
<li>防止自动更新: 找到Preferences -> Settings-User,然后在里面添加<code>"update_check":false</code></li>
<li>为了能够在终端直接打开Sublime,你可以建立一个软连接,在终端输入
<code>sudo ln -s "/Applications/Sublime Text.app/Contents/SharedSupport/bin/subl" /bin/subl</code>，然后就可以运行<code>subl --help</code>来查看命令帮助</li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">使用</span><span class="p">:</span>  <span class="n">subl</span> <span class="o">[</span><span class="err">参数</span><span class="o">]</span> <span class="o">[</span><span class="err">文件</span><span class="o">]</span>         <span class="err">编辑指定文件</span>
</span><span class='line'>   <span class="err">或</span><span class="p">:</span> <span class="n">subl</span> <span class="o">[</span><span class="err">参数</span><span class="o">]</span> <span class="o">[</span><span class="err">目录</span><span class="o">]</span>            <span class="err">打开指定目录</span>
</span><span class='line'>   <span class="err">或</span><span class="p">:</span> <span class="n">subl</span> <span class="o">[</span><span class="err">参数</span><span class="o">]</span> <span class="o">-</span>             <span class="err">编辑</span> <span class="n">stdin</span>
</span><span class='line'><span class="err">可用参数</span><span class="p">:</span>
</span><span class='line'>  <span class="o">--</span><span class="n">project</span> <span class="o">&lt;</span><span class="err">项目</span><span class="o">&gt;</span><span class="p">:</span> <span class="err">读取指定项目</span>
</span><span class='line'>  <span class="o">--</span><span class="n">command</span> <span class="o">&lt;</span><span class="err">命令</span><span class="o">&gt;</span><span class="p">:</span> <span class="err">运行指定命令</span>
</span><span class='line'>  <span class="o">-</span><span class="n">n</span> <span class="err">或</span> <span class="o">--</span><span class="kp">new</span><span class="o">-</span><span class="ss">window</span><span class="p">:</span>  <span class="err">打开新窗口</span>
</span><span class='line'>  <span class="o">-</span><span class="n">a</span> <span class="err">或</span> <span class="o">--</span><span class="ss">add</span><span class="p">:</span>         <span class="err">向当前窗口中添加文件夹</span>
</span><span class='line'>  <span class="o">-</span><span class="n">w</span> <span class="err">或</span> <span class="o">--</span><span class="ss">wait</span><span class="p">:</span>        <span class="err">等待文件关闭后再返回</span>
</span><span class='line'>  <span class="o">-</span><span class="n">b</span> <span class="err">或</span> <span class="o">--</span><span class="ss">background</span><span class="p">:</span>  <span class="err">不激活程序窗口</span>
</span><span class='line'>  <span class="o">-</span><span class="n">s</span> <span class="err">或</span> <span class="o">--</span><span class="ss">stay</span><span class="p">:</span>        <span class="err">关闭文件后保持程序窗口激活</span>
</span><span class='line'>  <span class="o">-</span><span class="n">h</span> <span class="err">或</span> <span class="o">--</span><span class="ss">help</span><span class="p">:</span>        <span class="err">显示此帮助</span>
</span><span class='line'>  <span class="o">-</span><span class="n">v</span> <span class="err">或</span> <span class="o">--</span><span class="ss">version</span><span class="p">:</span>     <span class="err">显示版本号</span>
</span><span class='line'><span class="err">读取</span> <span class="n">stdin</span> <span class="err">时会使用</span> <span class="o">--</span><span class="n">wait</span> <span class="err">参数。通过</span> <span class="o">--</span><span class="n">stay</span> <span class="err">可以在文件关闭后不返回终端（仅针对单个文件）。</span>
</span><span class='line'><span class="err">可以通过向文件名添加</span> <span class="sb">`:行号`</span> <span class="err">或</span> <span class="sb">`:行号:列号`</span> <span class="err">后缀来打开到更具体的位置。</span>
</span></code></pre></td></tr></table></div></figure>


<ol>
<li><p>开启自动换行：按住<code>command+shift+p</code>,输入<code>setting user</code>，往里面添加<code>"word_wrap" : true</code></p></li>
<li><p>最后的配置是这样的：</p></li>
</ol>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="s2">&quot;color_scheme&quot;</span><span class="p">:</span> <span class="s2">&quot;Packages/Theme - Flatland/Flatland Dark.tmTheme&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;font_size&quot;</span><span class="p">:</span> <span class="mi">13</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;ignored_packages&quot;</span><span class="p">:</span> <span class="o">[]</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;theme&quot;</span><span class="p">:</span> <span class="s2">&quot;Flatland Dark.sublime-theme&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;update_check&quot;</span><span class="p">:</span> <span class="kp">false</span><span class="p">,</span>
</span><span class='line'>  <span class="s2">&quot;word_wrap&quot;</span> <span class="p">:</span> <span class="kp">true</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/blog/2013/10/26/cong-vimdao-sublime-text//index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2013/10/24/rubyzhong-de-block/">
		
			Ruby中的block</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2013-10-24T18:16:00+08:00" pubdate data-updated="true"></time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/ruby/'>ruby</a>


</div>
    </div>
		

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/blog/2013/10/24/rubyzhong-de-block//index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2013/09/26/rubyzhong-de-instance-eavlhe-class-eval/">
		
			Ruby中的instance_eavl和class_eval</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2013-09-26T12:27:00+08:00" pubdate data-updated="true"></time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/ruby/'>ruby</a>


</div>
    </div>
		<p>第二次看Ruby元编程这本书，感觉里面能学到的东西很多，但是很容易忘记，所以把一些想法写下来，以备后用。</p>

<h1>instance_eval</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">My</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span>
</span><span class='line'>    <span class="vi">@v</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">obj</span> <span class="o">=</span> <span class="no">My</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="n">v</span> <span class="o">=</span> <span class="mi">3</span>
</span><span class='line'><span class="n">obj</span><span class="o">.</span><span class="n">instance_eval</span> <span class="k">do</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="nb">self</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="vi">@v</span>
</span><span class='line'>  <span class="nb">puts</span> <span class="n">v</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">one_method</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;I&#39;m one_method&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="c1">#=&gt; #&lt;My:0xa2b76a4&gt;</span>
</span><span class='line'><span class="c1">#=&gt; 1</span>
</span><span class='line'><span class="c1">#=&gt; 3</span>
</span><span class='line'><span class="n">obj</span><span class="o">.</span><span class="n">one_method</span>
</span><span class='line'><span class="c1">#=&gt; I&#39;m one_method</span>
</span><span class='line'><span class="n">obj2</span> <span class="o">=</span> <span class="no">My</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="n">obj2</span><span class="o">.</span><span class="n">one_method</span>
</span><span class='line'><span class="c1">#=&gt; NoMethodError: undefined method `one_method&#39; for #&lt;My:0xa2f3f14 @v=1&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><p>首先，我们分析上面代码：</p>

<ul>
<li>当我们实例化一个类时，我们可以通过instance_eval来访问到该类的实例方法，所以我们可以看到<code>self</code>返回一个对象，<code>@v</code>返回1</li>
<li>由于block是一个闭包，所以在运行的时候，可以访问局部变量<code>v</code>，而且能访问局部变量@v，这种情况，我们把他叫做<code>上下文探针</code>，它就像是一个深入到对象中的代码片段，对其进行操作。</li>
<li>当我们在instance_eval块里面定义方法是，由于self为当前对象，所以 <code>def</code>关键子打开的作用域门为self，即定义的方法只有obj可以访问，我们称它为单件方法。</li>
</ul>
</li>
<li><p>然后，我们总结instance_eval的作用：</p>

<ul>
<li>instance_eval的调用者必须是一个实例</li>
<li>改变当前block的接受者为self，因此它可以访问接受者的私有方法和实例变量</li>
<li>可以在block内使用单件方法</li>
</ul>
</li>
<li><p>最后，我们还发现，可以用instance_eavl来定义类方法</p></li>
</ul>


<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">A</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="n">A</span><span class="o">.</span><span class="n">instance_eval</span> <span class="k">do</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">a_method</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;I&#39;m class method&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="n">A</span><span class="o">.</span><span class="n">a_method</span>
</span><span class='line'><span class="c1">#=&gt;I&#39;m class method</span>
</span></code></pre></td></tr></table></div></figure>


<h1>class_eval(又名module_eval)</h1>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">def</span> <span class="nf">add_method_to</span><span class="p">(</span><span class="n">a_class</span><span class="p">)</span>
</span><span class='line'>  <span class="n">a_class</span><span class="o">.</span><span class="n">class_eval</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="nb">self</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">m</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s1">&#39;hello&#39;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'><span class="c1">#=&gt; String</span>
</span><span class='line'>
</span><span class='line'><span class="s2">&quot;abc&quot;</span><span class="o">.</span><span class="n">m</span>
</span><span class='line'><span class="n">add_method_to</span> <span class="nb">String</span>
</span><span class='line'><span class="s1">&#39;abc&#39;</span><span class="o">.</span><span class="n">m</span>
</span><span class='line'><span class="c1">#=&gt; NoMethodError: undefined method `m&#39; for &quot;abc&quot;:String</span>
</span><span class='line'><span class="c1">#=&gt; &quot;hello&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>分析上面代码，我们可以发现<code>class_eval</code>和<code>instance_eval</code>的区别：
  <em><code>class_eval</code>的调用对象必须是一个类
  </em><code>class_eval</code>block里面的self为类本身(实际上是重新打开了该类，相当于关键字<code>class</code>)
  *<code>class_eval</code>定义的方法为类的实例方法（instance_eval是单件方法）</li>
</ul>


<h1>总结：什么时候用<code>class_eval</code>和<code>instance_eval</code></h1>

<p>  <em>如果打开的对象不是类，则使用<code>instance_eval</code>,如果想打开一个类定义并且用<code>def</code>定义实例方法，则选择<code>class_eval</code>
  </em>根据调用者来决定
  *根据你的意图来决定</p>

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/blog/2013/09/26/rubyzhong-de-instance-eavlhe-class-eval//index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2013/08/10/asset-pipeline-li-jie/">
		
			Asset Pipeline 理解</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2013-08-10T16:46:00+08:00" pubdate data-updated="true"></time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/rails/'>rails</a>


</div>
    </div>
		<h3>如何管理数据</h3>

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/blog/2013/08/10/asset-pipeline-li-jie//index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2013/08/10/rspecce-shi-grurd-plus-sporcapybara/">
		
			Rspec测试(Grurd+spork+capybara)</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2013-08-10T16:45:00+08:00" pubdate data-updated="true"></time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/rspec/'>rspec</a>


</div>
    </div>
		

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/blog/2013/08/10/rspecce-shi-grurd-plus-sporcapybara//index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2013/07/15/chanceeasy-summary/">
		
			chanceEasy Summary</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


<time datetime="2013-07-15T08:39:00+08:00" pubdate data-updated="true"></time></div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/summary/'>summary</a>


</div>
    </div>
		<!--* 文档：文档规范化问题-->


<!--* 业务：业务不熟练-->


<!--    * 监控-->


<!--* 时间不够、状态不佳-->




<!--* 成员分工不明确、责职明确、目标不明确-->


<!--* 目标不明确、为完成任务而做任务、导致不思考、没动力、没状态-->


<!--* 文档描述不清、没有尽到该有的效果 、没有检查、监督文档-->


<!--* 决策有误-->


<!--* 开发气氛（头脑风暴、技术研究）-->


<!--* 责任心不强-->


<!--* 心里压力-->


<!--* 进度把控-->


<!--* 培养方案改革-->




<!--软件工程过程（需求文档、数据库设计、规范文档、代码封装文档）-->


<!--开发工具-->


<!--计划与进度把控-->


<!--团队面临问题-->


<h2>讲课内容</h2>

<!--偏向管理-->


<blockquote><p>今天分享的内容，主要是总结ChanceEasy第一阶段从需求分析到系统部署的整一个软件开发过程，每一个阶段所使用的工具、方法、和面临的问题和解决方法。</p>

<blockquote><ul>
<li>需求分析</li>
<li>数据库设计</li>
<li>开发过程</li>
<li>系统测试</li>
<li>系统部署</li>
<li>个人总结</li>
<li>讲课过程中，希望大家积极参与讨论</li>
</ul>
</blockquote></blockquote>

<h2>需求分析</h2>

<ul>
<li>方法：通过口头交流获取需求，分析单据信息，形成需求，实现页面原型，供用户确认；每次调研前的计划文档、调研后的总结文档；经过多次修改，形成确认版本，针对每个页面做详细开发注释文档</li>
<li>产物：流程图+页面原型+调研文档</li>
<li>优点：由于界面清晰可见，可以跟用户很好的进行沟通</li>
<li>缺点：文档规范性、可读性、可修改性、准确性、完整性（哪些要填哪些不要填）</li>
<li>经验总结：

<ul>
<li>流程图：必须准确无误、添加必要注释、能准确无误描述需求、（并需要和客户确认）</li>
<li>静态页面：尽量能够让这些前台代码能够在开发时使用，减少开发时间</li>
<li>开发文档：必须有非开发者检查、保证文档的准确性、可读性、无二义性</li>
<li>调研文档：由于需求跟改较快、文档过多、维护艰难</li>
<li>没站在客户的角度看问题、没形成数据流图</li>
</ul>
</li>
</ul>


<h2>数据库设计</h2>

<ul>
<li>方法：由每个模块的负责人提前设计好各自模块的数据库关系，根据页面原型，统一讨论各个模块的设计，并完成数据库关系图和Google文档、页面注释</li>
<li>产物：系统数据库关系图+Google文档+页面注释+状态文档</li>
<li>优点：能够清楚的知道数据库表间关系、数据库表字段定义可以直接导入</li>
<li>缺点：由于多人讨论，数据库表间关系、字段准确性很难确定；没进入实际开发，有些设计不合理</li>
<li>经验总结：

<ul>
<li>必须有人检查该过程所形成文档、确保文档的准确性、不然实际开发时，该文档并没有起到很好的作用</li>
<li>比较特殊的字段，必须写清楚为何这样设计</li>
<li>字段必须统一</li>
<li>充分考虑数据库的拓展性，为需求添加做准备</li>
</ul>
</li>
</ul>


<h2>代码封装</h2>

<ul>
<li>方法：根据之前开发经验，统一讨论需要封装的内容，并落实给每一个人。并完成相关文档</li>
<li>产物：Ruby+Js的API文档</li>
<li>优点：加快开发速度、有利于技术的提高</li>
<li>缺点：无</li>
<li>经验总结：

<ul>
<li>缺少代码质量监控，不能保证封装的代码已在使用->Redmine代码监控、Yammer通知</li>
<li>不能一味符合功能需求->果断摒弃不适合功能</li>
<li>代码封装应该交给经验较为丰富的开发者</li>
<li>在实际开发之前，必须把代码封装任务完成->待封装代码文档</li>
<li>共用性代码、文档准确性，详细性</li>
</ul>
</li>
</ul>


<h2>开发过程</h2>

<ul>
<li>方法：先大概讲下业务流程，开发者通过流程图、页面注释、数据库设计进行开发</li>
<li>产物：页面原型（每个页面的页面注释、所用到的数据库关系、表字段、单据）</li>
<li>优点：开发者能够明确获得开发时所需要的所有信息</li>
<li>缺点：维护这份文档比较困难、需要耗费时间长</li>
<li>开发总结：

<ul>
<li> 每天的三分钟会议无法获取进度且浪费时间，通过使用Yammer汇报进度、一周总的进度汇报</li>
<li> 代码质量->使用Redmine代码评审功能</li>
<li> 开发结果与需求不符、目标不明确</li>
<li> 由于实现的需要，有些问题已经跟原来需求相符->开发时间太长、再确认比较麻烦</li>
</ul>
</li>
</ul>


<h2>系统测试</h2>

<ul>
<li>方法： 各自负责页面进行测试、各自负责模块测试、负责人集成测试、用户验收测试</li>
<li>产物：测试文档</li>
<li>优点：</li>
<li>缺点： 需要大量的人工测试</li>
<li>经验总结：

<ul>
<li>经验不足，无法确定测试需要时间、没有明确的测试目标</li>
<li>没有自动化测试（测试驱动开发）</li>
</ul>
</li>
</ul>


<h2>系统部署</h2>

<ul>
<li>方法：配置待部署服务器、部署前准备工作、每一个人的培训安排</li>
<li>产物：部署计划、部署文档</li>
<li>优点：</li>
<li>缺点：</li>
</ul>


<h2>个人总结</h2>

<ul>
<li>计划的安排合理性->先试用、看是否安排合理</li>
<li>进度的把控</li>
<li>代码质量监控</li>
<li>任务完成情况把控</li>
<li>状态调整</li>
<li>解决问题->发现问题转变</li>
<li>目标不明确->为了完成任务而做任务、导致不思考、没动力、没状态</li>
<li>如何兼顾技术提高和项目进度合理（头脑风暴、技术讨论会）</li>
<li>实验室可以形成自己的代码库</li>
<li>决策失误</li>
<li>技术提升的三个阶段暑假培训、培训师弟、项目管理</li>
</ul>


<h2>实验室面临的问题</h2>

<ul>
<li>培训方案</li>
<li>项目压着我们，变成开发工具、学习不到东西</li>
</ul>


		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/blog/2013/07/15/chanceeasy-summary//index.html#disqus_thread">Comments</a></span>
	
</div>
</article>

<nav id="pagenavi">
    
    
        <a href="2" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav>

    </div>
    <footer id="footer">
    <div style="display:inline">
    Copyright &copy; 2015

    Justin-lu
. Powered by <a href="http://octopress.org">Octopress</a> | 
    Theme <a href="http://github.com/panks/fabric">fabric</a> by <a href="http://panks.me">Pankaj Kumar</a>
</div>


    </footer>
    <script src="/javascripts/fabric.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'justin-lu-blog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





<!-- end toload --> 
</div>
</div>
<script src="/javascripts/jquery.ui.totop.js" type="text/javascript"></script>
<script type="text/javascript">
/*<![CDATA[*/
;(function($){$().UItoTop({easingType:'easeOutCirc'});})(jQuery); 
/*]]>*/
</script><!-- remove it to remove the scroll to top button -->
</body>
</html>
