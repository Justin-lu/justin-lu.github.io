
<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<title>Hi I'm Justin-lu</title>
    <meta name="author" content="Justin-lu">
    
	<meta name="description" content="Published on: March 15, 2016 Tags: 部署 本教程将会涉及以下工具： Centos 7
[[RVM]]
Ruby 2.2.2
Rails 4.0.3
Passenger 4.0+
Nginx（由 Passenger 编译） 创建帐号 假设你已经用 root &hellip;">
	
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Hi I'm Justin-lu" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.ico" rel="shortcut icon">
    <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">

    <link href='http://fonts.googleapis.com/css?family=Slackey' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Fjalla+One' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Amethysta' rel='stylesheet' type='text/css'>
	<script type="text/javascript" src="/javascripts/jquery.min.js"></script>
    <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

    <script type="text/javascript" src="/javascripts/jquery-tapir.js"></script>

    <!-- remove or comment it to disable ajaxification -->
    <script type="text/javascript" src="/javascripts/ajaxify.js"></script>

    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?6ebf04dfe14a2e57a8b36abe0b1bae71";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>

    
    
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-42406282-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>


</head>


<body>
    <div id="wrapper">
    <header id="header" class="inner"><!-- for more effects see _animate.scss -->
<h1 class="animated bounceInDown">
    <div id="headerbg">
        Justin-lu
    </div>
</h1>
<br>

<ul id="social-links" style="text-align:center">
  
  <!-- GitHub -->
  <li>
  <a href="https://github.com/Justin-lu" class="github" title="Github"></a>
  </li>
  
  
  <!-- Google Plus -->
  <li>
  <a href="http://plus.google.com/Justin-lu?rel=author" class="google" title="Google+"></a>
  </li>
  
  
  
  
  
  
  
  
  <!-- Sina Weibo -->
  <li>
    <a href="http://weibo.com/luxiaoyong17" target="_blank">
      <svg width="40" height="40" class="sina-weibo" version="1.1" xmlns="http://www.w3.org/2000/svg">
        <path fill="" d="M9.641,17.231c-3.799,0.374-7.079-1.343-7.326-3.838c-0.246-2.494,2.634-4.82,6.434-5.196  c3.798-0.377,7.079,1.34,7.326,3.835C16.32,14.529,13.44,16.855,9.641,17.231 M17.24,8.952c-0.322-0.098-0.544-0.163-0.375-0.587  c0.365-0.921,0.403-1.718,0.007-2.286c-0.745-1.063-2.783-1.005-5.12-0.027c0-0.002-0.734,0.321-0.546-0.261  c0.359-1.156,0.305-2.123-0.254-2.682c-1.267-1.271-4.639,0.047-7.53,2.936C1.257,8.209,0,10.504,0,12.488  c0,3.796,4.866,6.104,9.628,6.104c6.241,0,10.393-3.627,10.393-6.506C20.021,10.347,18.557,9.358,17.24,8.952" />
        <path fill="" d="M21.384,2.005c-1.507-1.671-3.73-2.308-5.782-1.872l0,0c-0.475,0.102-0.778,0.569-0.676,1.043  c0.101,0.473,0.567,0.777,1.043,0.674c1.459-0.31,3.039,0.145,4.111,1.332c1.069,1.188,1.362,2.806,0.902,4.225v0.001  c-0.149,0.462,0.104,0.957,0.566,1.106c0.461,0.149,0.956-0.104,1.105-0.565c0,0,0-0.002,0-0.004  C23.299,5.95,22.894,3.674,21.384,2.005" />
        <path fill="" d="M19.07,4.094c-0.734-0.814-1.817-1.123-2.817-0.912c-0.409,0.088-0.671,0.49-0.581,0.899  c0.088,0.407,0.489,0.67,0.896,0.58v0.001c0.488-0.104,1.019,0.047,1.379,0.445c0.359,0.398,0.455,0.941,0.301,1.416l0,0  c-0.127,0.398,0.09,0.825,0.488,0.954c0.396,0.127,0.824-0.091,0.952-0.488C20,6.017,19.805,4.908,19.07,4.094" />
        <path fill="" d="M9.85,12.713c-0.132,0.229-0.426,0.338-0.656,0.242c-0.227-0.094-0.297-0.348-0.169-0.572  c0.132-0.221,0.416-0.328,0.64-0.239C9.895,12.227,9.978,12.483,9.85,12.713 M8.64,14.268c-0.367,0.586-1.154,0.843-1.747,0.57  c-0.584-0.265-0.756-0.945-0.389-1.518c0.362-0.568,1.124-0.824,1.712-0.574C8.811,12.998,9.001,13.675,8.64,14.268 M10.021,10.118  c-1.808-0.47-3.852,0.431-4.637,2.023c-0.8,1.624-0.026,3.428,1.801,4.017c1.892,0.612,4.122-0.324,4.898-2.078  C12.848,12.367,11.891,10.602,10.021,10.118" />
      </svg>
    </a>
  </li>
  
  
  <!-- Tencent Weibo -->
  <li>
    <a href="http://t.qq.com/gdjyluxiaoyong" target="_blank">
      <svg width="40" height="40" class="tencent-weibo" version="1.1" xmlns="http://www.w3.org/2000/svg">
        <circle fill="" cx="8.229" cy="10.478" r="2.543" />
        <path fill="" d="M8.229,18.163c-0.615,0-1.227-0.073-1.82-0.217  c-0.364-0.088-0.587-0.455-0.499-0.819c0.088-0.364,0.455-0.588,0.819-0.5c0.488,0.119,0.993,0.178,1.5,0.178  c3.49,0,6.33-2.839,6.33-6.329c0-3.49-2.839-6.33-6.33-6.33c-3.49,0-6.329,2.84-6.329,6.33c0,1.123,0.297,2.226,0.861,3.189  c0.189,0.323,0.08,0.739-0.243,0.928s-0.739,0.08-0.928-0.243c-0.685-1.172-1.046-2.511-1.046-3.875  c0-4.238,3.448-7.686,7.686-7.686c4.238,0,7.686,3.448,7.686,7.686C15.915,14.716,12.467,18.163,8.229,18.163z" />
        <path fill="" d="M2.066,24.549c-0.277,0-0.51-0.216-0.526-0.496c-0.021-0.351-0.451-8.643,5.989-13.397  c0.234-0.173,0.565-0.124,0.738,0.111c0.173,0.234,0.123,0.565-0.111,0.738C2.186,15.913,2.589,23.909,2.593,23.99  c0.018,0.29-0.204,0.541-0.495,0.558C2.087,24.548,2.077,24.549,2.066,24.549z" />
        <circle fill="" cx="22.443" cy="5.184" r="1.536" />
        <path fill="" d="M26.739,6.946c-0.141,0.344-0.322,0.669-0.538,0.967  c-0.133,0.184-0.389,0.224-0.572,0.091s-0.225-0.389-0.091-0.572c0.178-0.246,0.327-0.514,0.443-0.797  c0.8-1.951-0.136-4.188-2.086-4.988c-1.951-0.8-4.188,0.136-4.988,2.086c-0.8,1.951,0.136,4.188,2.086,4.988  c0.628,0.257,1.312,0.344,1.98,0.25c0.224-0.031,0.431,0.125,0.463,0.349c0.032,0.224-0.125,0.431-0.349,0.463  c-0.812,0.114-1.643,0.009-2.405-0.304c-2.369-0.971-3.505-3.688-2.534-6.057c0.972-2.369,3.688-3.505,6.058-2.534  C26.574,1.86,27.71,4.577,26.739,6.946z" />
        <path fill="" d="M28.895,11.854c-0.063,0.154-0.237,0.234-0.397,0.18c-0.201-0.068-4.934-1.729-6.115-6.419  c-0.043-0.17,0.061-0.343,0.231-0.386c0.171-0.043,0.344,0.06,0.388,0.231c1.095,4.348,5.656,5.956,5.703,5.971  c0.167,0.057,0.255,0.238,0.198,0.404C28.899,11.843,28.897,11.848,28.895,11.854z" />
      </svg>
    </a>
  </li>
  
</ul>


<!-- use full url including 'index.html' for navigation bar if you are using ajax -->
<ul id="nav">
	<li id="ajax"><a href="/index.html">Home</a></li>
	<li id="ajax"><a href="/blog/archives/index.html">Archives</a></li>
    <li id="ajax"><a href="/about-me/index.html">About Me</a></li>
    <li><a href="/atom.xml">RSS</a></li>
    
    <li>
    <div id="dark">
        <form method="get" action="/search.html" id="search">
            <input name="query" type="text" placeholder="Search..." x-webkit-speech />
        </form>
    </div>
    </li>
    
</ul>




</header>

<div id="toload">
<!-- begin toload --> 
    <div id="content" class="inner">
        


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2016/03/15/centos-shang-shi-yong-nginx-passenger-bu-shu-ruby-on-rails/">
		
			CentOS 上使用 Nginx Passenger 部署 Ruby on Rails</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


 March 15, 2016</div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/bu-shu/'>部署</a>


</div>
    </div>
		<p>本教程将会涉及以下工具：</p>

<ul>
<li>Centos 7</li>
<li>[[RVM]]</li>
<li>Ruby 2.2.2</li>
<li>Rails 4.0.3</li>
<li>Passenger 4.0+</li>
<li>Nginx（由 Passenger 编译）</li>
</ul>


<h2>创建帐号</h2>

<p>假设你已经用 root 帐号通过 SSH 登陆服务器, 没有登录的可以通过</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>ssh root@ip
</span></code></pre></td></tr></table></div></figure>


<p>出于安全考虑，不要使用 root 帐号运行 web 应用。这里新建一个专门用于部署的用户，例如 deploy 或者其它你喜欢的名字。运行以下命令创建用户：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># useradd -m -s /bin/bash deploy</span>
</span></code></pre></td></tr></table></div></figure>


<p>将用户加入 sudo 群组，以便使用 sudo 命令：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># adduser deploy sudo</span>
</span></code></pre></td></tr></table></div></figure>


<p>为 deploy 用户设置密码：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># passwd deploy</span>
</span></code></pre></td></tr></table></div></figure>


<p>为deploy用户添加管理员权限</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>sudo <span class="nb">echo</span> <span class="s2">&quot;$USER ALL=(ALL:ALL) ALL&quot;</span> &gt;&gt; /etc/sudoers
</span></code></pre></td></tr></table></div></figure>


<p>退出当前 SSH 链接，用 deploy 帐号重新登陆。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>ssh deploy@ip
</span></code></pre></td></tr></table></div></figure>


<h2>安装 RVM 和 Ruby</h2>

<p>更新 yum，并安装 curl：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>sudo yum update
</span><span class='line'><span class="nv">$ </span>sudo yum install curl
</span></code></pre></td></tr></table></div></figure>


<p>然后安装 RVM：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>gpg --keyserver hkp://keys.gnupg.net --recv-keys 409B6B1796C275462A1703113804BB82D39DC0E3
</span><span class='line'><span class="nv">$ </span><span class="se">\c</span>url -sSL https://get.rvm.io <span class="p">|</span> bash -s stable
</span><span class='line'><span class="nv">$ </span>rvm requirements
</span></code></pre></td></tr></table></div></figure>


<p>RVM 安装完毕后，重新登陆 SSH，让 RVM 配置生效。然后安装 Ruby 2.1.2：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>rvm use --install --default 2.2.2
</span><span class='line'><span class="nv">$ </span>rvm use 2.2.2@deploy --create --default
</span><span class='line'><span class="nv">$ </span>gem install bundle
</span></code></pre></td></tr></table></div></figure>


<p>安装完毕后，确认目前的 Ruby 版本：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>ruby -v
</span></code></pre></td></tr></table></div></figure>


<p>应该看到 <code>ruby 2.2.2p95 (2015-04-13 revision 50295) [x86_64-linux]</code> 字样。</p>

<h2>安装 Passenger</h2>

<p><a href="https://www.phusionpassenger.com/">Passenger</a> 是一个 app server，支持基于 Rack 框架的 Ruby app（包括 Rails）。Passenger 的特点是需要作为模块编译到 Nginx 中，优点是配置简单，不需要自己写启动脚本。</p>

<p>安装 Passenger 最简单的方法是通过 yum 安装，首先导入 Passenger 的密钥（<a href="https://www.phusionpassenger.com/library/install/nginx/install/oss/el7/">官方文档</a>）：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c"># 安装 EPEL and 和其他依赖</span>
</span><span class='line'><span class="nv">$ </span>sudo yum install -y epel-release pygpgme curl
</span><span class='line'>
</span><span class='line'><span class="c"># 添加el7仓库</span>
</span><span class='line'><span class="nv">$ </span>sudo curl --fail -sSLo /etc/yum.repos.d/passenger.repo https://oss-binaries.phusionpassenger.com/yum/definitions/el-passenger.repo
</span><span class='line'>
</span><span class='line'><span class="c"># 安装Passenger 和 Nginx， 由于万恶的墙，有可能失败，多试几次就可以</span>
</span><span class='line'><span class="nv">$ </span>sudo yum install -y nginx passenger
</span></code></pre></td></tr></table></div></figure>


<p>现在修改 nginx 配置，编辑 <code>/etc/nginx/conf.d/passenger.conf</code>，找到这三行注释：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="c">#passenger_root /usr/share/ruby/vendor_ruby/phusion_passenger/locations.ini;</span>
</span><span class='line'><span class="c">#passenger_ruby /usr/bin/ruby;</span>
</span><span class='line'><span class="c">#passenger_instance_registry_dir /var/run/passenger-instreg;</span>
</span></code></pre></td></tr></table></div></figure>


<p>将它修改为：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>passenger_root /usr/share/ruby/vendor_ruby/phusion_passenger/locations.ini<span class="p">;</span>
</span><span class='line'>passenger_ruby /usr/bin/ruby<span class="p">;</span>
</span><span class='line'>passenger_instance_registry_dir /var/run/passenger-instreg<span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>重启Nginx:</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sudo service nginx restart
</span></code></pre></td></tr></table></div></figure>


<p>检查是否安装成功</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sudo passenger-config validate-install
</span></code></pre></td></tr></table></div></figure>


<p>查看nginx和passgenr是否运行成功</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>sudo passenger-memory-stats
</span></code></pre></td></tr></table></div></figure>


<p>可以看到这个，说明已经成功运行</p>

<p><img src="quiver-image-url/36FF0FFBAC4DC86FB7F27AB8039F3103.jpg" alt="1__deploy_zhouyi__etc__ssh_.jpg" /></p>

<h2>安装Nodejs</h2>

<p><a href="https://www.digitalocean.com/community/tutorials/how-to-install-node-js-on-a-centos-7-server">https://www.digitalocean.com/community/tutorials/how-to-install-node-js-on-a-centos-7-server</a></p>

<h2>部署<code>Rails</code>项目</h2>

<h3>新建<code>Rails</code>项目</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="err">$</span> <span class="n">rails</span> <span class="kp">new</span> <span class="n">app</span>
</span><span class='line'><span class="err">$</span> <span class="n">cd</span> <span class="n">app</span>
</span><span class='line'><span class="err">$</span> <span class="n">bundle</span> <span class="n">install</span>
</span></code></pre></td></tr></table></div></figure>


<h3>打开<code>Gemfile</code>文件，在<code>Gemfile</code>的<code>development</code>和<code>test</code>group 添加<code>capistrano</code>和<code>rvm-capistrano</code></h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="n">group</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span> <span class="k">do</span>
</span><span class='line'>  <span class="c1"># Use Capistrano for deployment</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;capistrano&#39;</span><span class="p">,</span> <span class="s2">&quot;~&gt; 2.15.5&quot;</span>
</span><span class='line'>  <span class="n">gem</span> <span class="s1">&#39;rvm-capistrano&#39;</span><span class="p">,</span> <span class="s1">&#39;~&gt; 1.4.1&#39;</span><span class="p">,</span> <span class="ss">:require</span> <span class="o">=&gt;</span> <span class="kp">false</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>生成<code>cap</code>文件,在终端运行，会自动生成<code>Capfile</code>和<code>config/deploy.rb</code></h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>capify .
</span></code></pre></td></tr></table></div></figure>


<h3>修改<code>deploy</code>文件，配置项就不逐一介绍了，可以阅读 Capistrano 的文档 2.x Getting Started。主要是修改 :rvm_ruby_string 和 :repository 两个，其它再按需修改。</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="nb">require</span> <span class="s1">&#39;rvm/capistrano&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">set</span> <span class="ss">:rvm_type</span><span class="p">,</span> <span class="ss">:user</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># repo details</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:scm</span><span class="p">,</span> <span class="ss">:git</span>
</span><span class='line'><span class="c1"># need to clean shared/cached-copy if changed repository</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:repository</span><span class="p">,</span> <span class="s2">&quot;your repository url&quot;</span>
</span><span class='line'><span class="c1"># set :branch, &quot;master&quot;</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:git_enable_submodules</span><span class="p">,</span> <span class="mi">1</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># bundler bootstrap</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;bundler/capistrano&#39;</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:bundle_without</span><span class="p">,</span> <span class="o">[</span><span class="ss">:darwin</span><span class="p">,</span> <span class="ss">:development</span><span class="p">,</span> <span class="ss">:test</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Multi stage</span>
</span><span class='line'><span class="c1"># https://github.com/capistrano/capistrano/wiki/2.x-Multistage-Extension</span>
</span><span class='line'><span class="c1"># https://github.com/VinceMD/Scem/wiki/Deploying-on-production</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:stages</span><span class="p">,</span> <span class="sx">%w(production)</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:default_stage</span><span class="p">,</span> <span class="s2">&quot;production&quot;</span> <span class="c1"># require config/deploy/staging.rb</span>
</span><span class='line'><span class="c1"># set :default_stage, &quot;production&quot; # require config/deploy/production.rb</span>
</span><span class='line'><span class="nb">require</span> <span class="s1">&#39;capistrano/ext/multistage&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># server details</span>
</span><span class='line'><span class="n">default_run_options</span><span class="o">[</span><span class="ss">:pty</span><span class="o">]</span> <span class="o">=</span> <span class="kp">true</span> <span class="c1"># apparently helps with passphrase prompting</span>
</span><span class='line'><span class="n">ssh_options</span><span class="o">[</span><span class="ss">:forward_agent</span><span class="o">]</span> <span class="o">=</span> <span class="kp">true</span> <span class="c1"># tells cap to use my local private key</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:deploy_via</span><span class="p">,</span> <span class="ss">:remote_cache</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:use_sudo</span><span class="p">,</span> <span class="kp">false</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># integrate whenever</span>
</span><span class='line'><span class="c1"># when using bundler</span>
</span><span class='line'><span class="c1"># set :whenever_command, &quot;bundle exec whenever&quot;</span>
</span><span class='line'><span class="c1"># when using different environments</span>
</span><span class='line'><span class="c1"># set :whenever_environment, defer { stage }</span>
</span><span class='line'><span class="c1"># set :whenever_identifier, defer { &quot;#{fetch(:application)}-#{fetch(:rails_env)}&quot; }</span>
</span><span class='line'><span class="c1"># require &quot;whenever/capistrano&quot;</span>
</span><span class='line'><span class="c1"># https://github.com/javan/whenever/blob/master/lib/whenever/capistrano.rb</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># tasks</span>
</span><span class='line'><span class="n">namespace</span> <span class="ss">:deploy</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:start</span><span class="p">,</span> <span class="ss">:roles</span> <span class="o">=&gt;</span> <span class="ss">:app</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">run</span> <span class="s2">&quot;touch </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">/tmp/restart.txt&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:stop</span><span class="p">,</span> <span class="ss">:roles</span> <span class="o">=&gt;</span> <span class="ss">:app</span> <span class="k">do</span>
</span><span class='line'>    <span class="c1"># Do nothing.</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">desc</span> <span class="s2">&quot;Restart Application&quot;</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:restart</span><span class="p">,</span> <span class="ss">:roles</span> <span class="o">=&gt;</span> <span class="ss">:app</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">run</span> <span class="s2">&quot;touch </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">/tmp/restart.txt&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">desc</span> <span class="s2">&quot;Symlink shared resources on each release&quot;</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:symlink_shared</span><span class="p">,</span> <span class="ss">:roles</span> <span class="o">=&gt;</span> <span class="ss">:app</span> <span class="k">do</span>
</span><span class='line'>    <span class="sx">%w{database settings.local}</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span>
</span><span class='line'>      <span class="n">run</span> <span class="s2">&quot;ln -nfs </span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/config/</span><span class="si">#{</span><span class="n">file</span><span class="si">}</span><span class="s2">.yml </span><span class="si">#{</span><span class="n">release_path</span><span class="si">}</span><span class="s2">/config/</span><span class="si">#{</span><span class="n">file</span><span class="si">}</span><span class="s2">.yml&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># link dirs in public/</span>
</span><span class='line'>    <span class="sx">%w{uploads}</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">dir</span><span class="o">|</span>
</span><span class='line'>      <span class="n">run</span> <span class="s2">&quot;mkdir -p </span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/public/</span><span class="si">#{</span><span class="n">dir</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="n">run</span> <span class="s2">&quot;ln -nfs </span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/public/</span><span class="si">#{</span><span class="n">dir</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">release_path</span><span class="si">}</span><span class="s2">/public/</span><span class="si">#{</span><span class="n">dir</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">desc</span> <span class="s2">&quot;Initialize configuration using example files provided in the distribution&quot;</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:upload_config</span> <span class="k">do</span>
</span><span class='line'>    <span class="sx">%w{config}</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">dir</span><span class="o">|</span>
</span><span class='line'>      <span class="n">run</span> <span class="s2">&quot;mkdir -p </span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">dir</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="no">Dir</span><span class="o">[</span><span class="s2">&quot;config/*.yml.example&quot;</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span>
</span><span class='line'>      <span class="n">top</span><span class="o">.</span><span class="n">upload</span><span class="p">(</span><span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="n">file</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/config/</span><span class="si">#{</span><span class="no">File</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;.example&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">desc</span> <span class="s1">&#39;Visit the app&#39;</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:visit_web</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">system</span> <span class="s2">&quot;open </span><span class="si">#{</span><span class="n">app_url</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">after</span> <span class="s1">&#39;deploy:setup&#39;</span><span class="p">,</span> <span class="s1">&#39;deploy:upload_config&#39;</span>
</span><span class='line'><span class="n">after</span> <span class="s1">&#39;deploy:update_code&#39;</span><span class="p">,</span> <span class="s1">&#39;deploy:symlink_shared&#39;</span>
</span><span class='line'><span class="n">after</span> <span class="s1">&#39;deploy:restart&#39;</span><span class="p">,</span> <span class="s1">&#39;deploy:visit_web&#39;</span>
</span><span class='line'><span class="n">after</span> <span class="s1">&#39;deploy:migrations&#39;</span><span class="p">,</span> <span class="s1">&#39;deploy:cleanup&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">set</span> <span class="ss">:keep_releases</span><span class="p">,</span> <span class="mi">7</span> <span class="c1"># number for keeping old releases</span>
</span><span class='line'><span class="n">after</span> <span class="s1">&#39;deploy&#39;</span><span class="p">,</span> <span class="s1">&#39;deploy:cleanup&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="n">namespace</span> <span class="ss">:db</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">desc</span> <span class="s2">&quot;Create db for current env&quot;</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:create</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">run</span> <span class="s2">&quot;cd </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">; bundle exec rake db:create RAILS_ENV=</span><span class="si">#{</span><span class="n">rails_env</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s1">&#39;could be able to run `cap deploy:migrate` now&#39;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">desc</span> <span class="s2">&quot;Populates the Production Database&quot;</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:seed</span> <span class="k">do</span>
</span><span class='line'>    <span class="nb">puts</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">=== Populating the Production Database! ===</span><span class="se">\n\n</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="n">run</span> <span class="s2">&quot;cd </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">; bundle exec rake db:seed RAILS_ENV=</span><span class="si">#{</span><span class="n">rails_env</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># http://guides.rubyonrails.org/asset_pipeline.html#precompiling-assets</span>
</span><span class='line'><span class="c1"># https://github.com/capistrano/capistrano/blob/master/lib/capistrano/recipes/deploy/assets.rb</span>
</span><span class='line'><span class="nb">load</span> <span class="s1">&#39;deploy/assets&#39;</span> <span class="k">unless</span> <span class="p">(</span><span class="no">ARGV</span><span class="o">.</span><span class="n">join</span> <span class="o">==</span> <span class="s2">&quot;deploy:update&quot;</span> <span class="o">||</span> <span class="no">ARGV</span><span class="o">.</span><span class="n">last</span> <span class="o">==</span> <span class="s1">&#39;deploy:update&#39;</span><span class="p">)</span>
</span><span class='line'><span class="c1"># then we got these tasks:</span>
</span><span class='line'><span class="c1"># cap deploy:assets:clean      # Run the asset clean rake task.</span>
</span><span class='line'><span class="c1"># cap deploy:assets:precompile # Run the asset precompilation rake task.</span>
</span><span class='line'><span class="n">namespace</span> <span class="ss">:remote</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">desc</span> <span class="s2">&quot;Open the rails console on one of the remote servers&quot;</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:console</span><span class="p">,</span> <span class="ss">:roles</span> <span class="o">=&gt;</span> <span class="ss">:app</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">hostname</span> <span class="o">=</span> <span class="n">find_servers_for_task</span><span class="p">(</span><span class="n">current_task</span><span class="p">)</span><span class="o">.</span><span class="n">first</span>
</span><span class='line'>    <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;cd </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2"> &amp;&amp; bundle exec rails console </span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:rails_env</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">fetch</span><span class="p">(</span><span class="ss">:rvm_ruby_string</span><span class="p">)</span>
</span><span class='line'>      <span class="c1"># set rvm shell and get ride of &quot;&#39;&quot;</span>
</span><span class='line'>      <span class="c1"># https://github.com/wayneeseguin/rvm/blob/master/lib/rvm/capistrano.rb</span>
</span><span class='line'>      <span class="n">rvm_shell</span> <span class="o">=</span> <span class="sx">%{rvm_path=$HOME/.rvm $HOME/.rvm/bin/rvm-shell &quot;</span><span class="si">#{</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:rvm_ruby_string</span><span class="p">)</span><span class="si">}</span><span class="sx">&quot;}</span>
</span><span class='line'>      <span class="n">command</span> <span class="o">=</span> <span class="sx">%{</span><span class="si">#{</span><span class="n">rvm_shell</span><span class="si">}</span><span class="sx"> -c &quot;</span><span class="si">#{</span><span class="n">command</span><span class="si">}</span><span class="sx">&quot;}</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">command</span> <span class="o">=</span> <span class="sx">%{source ~/.profile &amp;&amp; &quot;</span><span class="si">#{</span><span class="n">command</span><span class="si">}</span><span class="sx">&quot;}</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="nb">exec</span> <span class="sx">%{ssh -l </span><span class="si">#{</span><span class="n">user</span><span class="si">}</span><span class="sx"> </span><span class="si">#{</span><span class="n">hostname</span><span class="si">}</span><span class="sx"> -t &#39;</span><span class="si">#{</span><span class="n">command</span><span class="si">}</span><span class="sx">&#39;}</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">desc</span> <span class="s2">&quot;run rake task. e.g.: `cap remote:rake db:version`&quot;</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:rake</span> <span class="k">do</span>
</span><span class='line'>    <span class="no">ARGV</span><span class="o">.</span><span class="n">values_at</span><span class="p">(</span><span class="no">Range</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">ARGV</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;remote:rake&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">rake_task</span><span class="o">|</span>
</span><span class='line'>      <span class="n">top</span><span class="o">.</span><span class="n">run</span> <span class="s2">&quot;cd </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2"> &amp;&amp; RAILS_ENV=</span><span class="si">#{</span><span class="n">rails_env</span><span class="si">}</span><span class="s2"> bundle exec rake </span><span class="si">#{</span><span class="n">rake_task</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">desc</span> <span class="s2">&quot;run remote command. e.g.: `cap remote:run &#39;tail -n 10 log/production.log&#39;`&quot;</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:run</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">command</span> <span class="o">=</span> <span class="no">ARGV</span><span class="o">.</span><span class="n">values_at</span><span class="p">(</span><span class="no">Range</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">ARGV</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;remote:run&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</span><span class='line'>    <span class="n">top</span><span class="o">.</span><span class="n">run</span> <span class="s2">&quot;cd </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">; RAILS_ENV=</span><span class="si">#{</span><span class="n">rails_env</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">command</span><span class="o">*</span><span class="s1">&#39; &#39;</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">desc</span> <span class="s1">&#39;run specified rails code on server. e.g.: `cap remote:runner p User.all` or `cap remote:runner &quot;User.all.each{ |u| p u }&quot;`&#39;</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:runner</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">command</span><span class="o">=</span><span class="no">ARGV</span><span class="o">.</span><span class="n">values_at</span><span class="p">(</span><span class="no">Range</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">ARGV</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;remote:runner&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
</span><span class='line'>    <span class="n">top</span><span class="o">.</span><span class="n">run</span> <span class="s2">&quot;cd </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">; RAILS_ENV=</span><span class="si">#{</span><span class="n">rails_env</span><span class="si">}</span><span class="s2"> bundle exec rails runner &#39;</span><span class="si">#{</span><span class="n">command</span><span class="o">*</span><span class="s1">&#39; &#39;</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
</span><span class='line'>    <span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">desc</span> <span class="s2">&quot;tail log on remote server&quot;</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:tail_log</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">top</span><span class="o">.</span><span class="n">run</span> <span class="s2">&quot;tail -f </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">/log/</span><span class="si">#{</span><span class="n">rails_env</span><span class="si">}</span><span class="s2">.log&quot;</span> <span class="k">do</span> <span class="o">|</span><span class="n">channel</span><span class="p">,</span> <span class="n">stream</span><span class="p">,</span> <span class="n">data</span><span class="o">|</span>
</span><span class='line'>      <span class="nb">puts</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">data</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="k">break</span> <span class="k">if</span> <span class="n">stream</span> <span class="o">==</span> <span class="ss">:err</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>    <span class="nb">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="n">namespace</span> <span class="ss">:update</span> <span class="k">do</span>
</span><span class='line'>  <span class="n">desc</span> <span class="s2">&quot;Dump remote database into tmp/, download file to local machine, import into local database&quot;</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:database</span> <span class="k">do</span>
</span><span class='line'>    <span class="c1"># config</span>
</span><span class='line'>    <span class="n">remote_db_yml_path</span>          <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/config/database.yml&quot;</span>
</span><span class='line'>    <span class="n">remote_db_yml_on_local_path</span> <span class="o">=</span> <span class="s2">&quot;tmp/database_</span><span class="si">#{</span><span class="n">rails_env</span><span class="si">}</span><span class="s2">.yml&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># First lets get the remote database config file so that we can read in the database settings</span>
</span><span class='line'>    <span class="n">get</span> <span class="n">remote_db_yml_path</span><span class="p">,</span> <span class="n">remote_db_yml_on_local_path</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># load the remote settings within the database file</span>
</span><span class='line'>    <span class="n">remote_settings</span> <span class="o">=</span> <span class="no">YAML</span><span class="o">::</span><span class="n">load_file</span><span class="p">(</span><span class="n">remote_db_yml_on_local_path</span><span class="p">)</span><span class="o">[</span><span class="n">rails_env</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">remote_sql_file_path</span>        <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">/tmp/</span><span class="si">#{</span><span class="n">rails_env</span><span class="si">}</span><span class="s2">-</span><span class="si">#{</span><span class="n">remote_settings</span><span class="o">[</span><span class="s2">&quot;database&quot;</span><span class="o">]</span><span class="si">}</span><span class="s2">-dump.sql&quot;</span>
</span><span class='line'>    <span class="n">remote_sql_gz_file_path</span>     <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">remote_sql_file_path</span><span class="si">}</span><span class="s2">.gz&quot;</span>
</span><span class='line'>    <span class="n">local_sql_file_path</span>         <span class="o">=</span> <span class="s2">&quot;tmp/</span><span class="si">#{</span><span class="n">rails_env</span><span class="si">}</span><span class="s2">-</span><span class="si">#{</span><span class="n">remote_settings</span><span class="o">[</span><span class="s2">&quot;database&quot;</span><span class="o">]</span><span class="si">}</span><span class="s2">-</span><span class="si">#{</span><span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-%d_%H:%M:%S&quot;</span><span class="p">)</span><span class="si">}</span><span class="s2">.sql&quot;</span>
</span><span class='line'>    <span class="n">local_sql_gz_file_path</span>      <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">local_sql_file_path</span><span class="si">}</span><span class="s2">.gz&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># we also need the local settings so that we can import the fresh database properly</span>
</span><span class='line'>    <span class="n">local_settings</span> <span class="o">=</span> <span class="no">YAML</span><span class="o">::</span><span class="n">load_file</span><span class="p">(</span><span class="s2">&quot;config/database.yml&quot;</span><span class="p">)</span><span class="o">[</span><span class="n">rails_env</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># dump the remote database and store it in the current path&#39;s tmp directory.</span>
</span><span class='line'>    <span class="n">run</span> <span class="s2">&quot;mysqldump -u&#39;</span><span class="si">#{</span><span class="n">remote_settings</span><span class="o">[</span><span class="s2">&quot;username&quot;</span><span class="o">]</span><span class="si">}</span><span class="s2">&#39; -p&#39;</span><span class="si">#{</span><span class="n">remote_settings</span><span class="o">[</span><span class="s2">&quot;password&quot;</span><span class="o">]</span><span class="si">}</span><span class="s2">&#39; </span><span class="si">#{</span><span class="s2">&quot;-h &#39;</span><span class="si">#{</span><span class="n">remote_settings</span><span class="o">[</span><span class="s2">&quot;host&quot;</span><span class="o">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="k">if</span> <span class="n">remote_settings</span><span class="o">[</span><span class="s2">&quot;host&quot;</span><span class="o">]</span><span class="si">}</span><span class="s2"> &#39;</span><span class="si">#{</span><span class="n">remote_settings</span><span class="o">[</span><span class="s2">&quot;database&quot;</span><span class="o">]</span><span class="si">}</span><span class="s2">&#39; &gt; </span><span class="si">#{</span><span class="n">remote_sql_file_path</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># gzip db</span>
</span><span class='line'>    <span class="n">run</span> <span class="s2">&quot;gzip -f </span><span class="si">#{</span><span class="n">remote_sql_file_path</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># download gz file to local</span>
</span><span class='line'>    <span class="n">get</span> <span class="n">remote_sql_gz_file_path</span><span class="p">,</span> <span class="n">local_sql_gz_file_path</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># unzip sql</span>
</span><span class='line'>    <span class="n">run_locally</span> <span class="s2">&quot;gunzip </span><span class="si">#{</span><span class="n">local_sql_gz_file_path</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># import db to local db</span>
</span><span class='line'>    <span class="c1"># may need to run `RAILS_ENV=production rake db:create` on local first</span>
</span><span class='line'>    <span class="n">run_locally</span><span class="p">(</span><span class="s2">&quot;mysql -u</span><span class="si">#{</span><span class="n">local_settings</span><span class="o">[</span><span class="s2">&quot;username&quot;</span><span class="o">]</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="s2">&quot;-p</span><span class="si">#{</span><span class="n">local_settings</span><span class="o">[</span><span class="s2">&quot;password&quot;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">local_settings</span><span class="o">[</span><span class="s2">&quot;password&quot;</span><span class="o">]</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">local_settings</span><span class="o">[</span><span class="s2">&quot;database&quot;</span><span class="o">]</span><span class="si">}</span><span class="s2"> &lt; </span><span class="si">#{</span><span class="n">local_sql_file_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># now that we have the upated production dump file we should use the local settings to import this db.</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">desc</span> <span class="s2">&quot;Mirrors the remote shared public directory with your local copy, doesn&#39;t download symlinks&quot;</span>
</span><span class='line'>  <span class="n">task</span> <span class="ss">:shared_assets</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">run_locally</span> <span class="s2">&quot;if [ -e public/uploads ]; then mv public/uploads public/uploads_back; fi&quot;</span>
</span><span class='line'>    <span class="c1"># using rsync so that it only copies what it needs</span>
</span><span class='line'>    <span class="n">run_locally</span><span class="p">(</span><span class="s2">&quot;rsync --recursive --times --rsh=ssh --compress --human-readable --progress </span><span class="si">#{</span><span class="n">user</span><span class="si">}</span><span class="s2">@</span><span class="si">#{</span><span class="n">app_server</span><span class="si">}</span><span class="s2">:</span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/system/ public/system/&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">run_locally</span><span class="p">(</span><span class="s2">&quot;rsync --recursive --times --rsh=ssh --compress --human-readable --progress </span><span class="si">#{</span><span class="n">user</span><span class="si">}</span><span class="s2">@</span><span class="si">#{</span><span class="n">app_server</span><span class="si">}</span><span class="s2">:</span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/public/uploads/ public/uploads/&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">namespace</span> <span class="ss">:remote</span> <span class="k">do</span>
</span><span class='line'>    <span class="n">desc</span> <span class="s2">&quot;update the remote database with the local database&quot;</span>
</span><span class='line'>    <span class="n">task</span> <span class="ss">:database</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">input</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
</span><span class='line'>      <span class="c1"># STDOUT.puts &quot;Are you SURE to update the databse of remote?(YES)&quot;</span>
</span><span class='line'>      <span class="c1"># confirmation = STDIN.gets.chomp</span>
</span><span class='line'>      <span class="n">confirmation</span> <span class="o">=</span> <span class="no">Capistrano</span><span class="o">::</span><span class="no">CLI</span><span class="o">.</span><span class="n">ui</span><span class="o">.</span><span class="n">ask</span><span class="p">(</span><span class="s2">&quot;Are you SURE to update the databse of remote?(YES)&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="nb">abort</span> <span class="s2">&quot;Interrupt..&quot;</span> <span class="k">unless</span> <span class="n">confirmation</span> <span class="o">==</span> <span class="s2">&quot;YES&quot;</span>
</span><span class='line'>      <span class="c1"># config database.yml on both sides</span>
</span><span class='line'>      <span class="n">remote_db_yml_path</span>          <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/config/database.yml&quot;</span>
</span><span class='line'>      <span class="n">remote_db_yml_on_local_path</span> <span class="o">=</span> <span class="s2">&quot;tmp/database_</span><span class="si">#{</span><span class="n">rails_env</span><span class="si">}</span><span class="s2">.yml&quot;</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># First get the local database config to remote</span>
</span><span class='line'>      <span class="n">get</span> <span class="n">remote_db_yml_path</span><span class="p">,</span> <span class="n">remote_db_yml_on_local_path</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># load the local settings within the database file</span>
</span><span class='line'>      <span class="n">local_settings</span> <span class="o">=</span> <span class="no">YAML</span><span class="o">::</span><span class="n">load_file</span><span class="p">(</span><span class="s2">&quot;config/database.yml&quot;</span><span class="p">)</span><span class="o">[</span><span class="n">rails_env</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># set the sql path on both sides</span>
</span><span class='line'>      <span class="n">local_sql_file_path</span> <span class="o">=</span> <span class="s2">&quot;tmp/</span><span class="si">#{</span><span class="n">rails_env</span><span class="si">}</span><span class="s2">-</span><span class="si">#{</span><span class="n">local_settings</span><span class="o">[</span><span class="s1">&#39;database&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">-dump.sql&quot;</span>
</span><span class='line'>      <span class="n">local_sql_gz_file_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">local_sql_file_path</span><span class="si">}</span><span class="s2">.gz&quot;</span>
</span><span class='line'>      <span class="n">remote_sql_file_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">/tmp/</span><span class="si">#{</span><span class="n">rails_env</span><span class="si">}</span><span class="s2">-</span><span class="si">#{</span><span class="n">local_settings</span><span class="o">[</span><span class="s1">&#39;database&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">-</span><span class="si">#{</span><span class="no">Time</span><span class="o">.</span><span class="n">now</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-%d_%H:%M:%S&quot;</span><span class="p">)</span><span class="si">}</span><span class="s2">.sql&quot;</span>
</span><span class='line'>      <span class="n">remote_sql_gz_file_path</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">remote_sql_file_path</span><span class="si">}</span><span class="s2">.gz&quot;</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># we also need the remote settings so that we can import the fresh dataabse properly</span>
</span><span class='line'>      <span class="n">remote_settings</span> <span class="o">=</span> <span class="no">YAML</span><span class="o">::</span><span class="n">load_file</span><span class="p">(</span><span class="n">remote_db_yml_on_local_path</span><span class="p">)</span><span class="o">[</span><span class="n">rails_env</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># dump the local database and store it in the tmp dir</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">local_settings</span><span class="o">[</span><span class="s1">&#39;adapter&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s1">&#39;postgresql&#39;</span>
</span><span class='line'>        <span class="n">run_locally</span> <span class="s2">&quot;PGPASSWORD=&#39;</span><span class="si">#{</span><span class="n">local_settings</span><span class="o">[</span><span class="s1">&#39;password&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&#39; pg_dump  -U </span><span class="si">#{</span><span class="n">local_settings</span><span class="o">[</span><span class="s2">&quot;username&quot;</span><span class="o">]</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="s2">&quot;-h &#39;</span><span class="si">#{</span><span class="n">local_settings</span><span class="o">[</span><span class="s2">&quot;host&quot;</span><span class="o">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="k">if</span> <span class="n">local_settings</span><span class="o">[</span><span class="s2">&quot;host&quot;</span><span class="o">]</span><span class="si">}</span><span class="s2"> -c -O &#39;</span><span class="si">#{</span><span class="n">local_settings</span><span class="o">[</span><span class="s2">&quot;database&quot;</span><span class="o">]</span><span class="si">}</span><span class="s2">&#39; &gt; </span><span class="si">#{</span><span class="n">local_sql_file_path</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="k">elsif</span> <span class="n">local_settings</span><span class="o">[</span><span class="s1">&#39;adapter&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s1">&#39;mysql2&#39;</span>
</span><span class='line'>        <span class="n">run_locally</span> <span class="s2">&quot;mysqldump -u&#39;</span><span class="si">#{</span><span class="n">local_settings</span><span class="o">[</span><span class="s2">&quot;username&quot;</span><span class="o">]</span><span class="si">}</span><span class="s2">&#39; </span><span class="si">#{</span><span class="s2">&quot;-p</span><span class="si">#{</span><span class="n">local_settings</span><span class="o">[</span><span class="s2">&quot;password&quot;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">local_settings</span><span class="o">[</span><span class="s2">&quot;password&quot;</span><span class="o">]</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="s2">&quot;-h &#39;</span><span class="si">#{</span><span class="n">local_settings</span><span class="o">[</span><span class="s2">&quot;host&quot;</span><span class="o">]</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="k">if</span> <span class="n">local_settings</span><span class="o">[</span><span class="s2">&quot;host&quot;</span><span class="o">]</span><span class="si">}</span><span class="s2"> &#39;</span><span class="si">#{</span><span class="n">local_settings</span><span class="o">[</span><span class="s2">&quot;database&quot;</span><span class="o">]</span><span class="si">}</span><span class="s2">&#39; &gt; </span><span class="si">#{</span><span class="n">local_sql_file_path</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="k">raise</span> <span class="s2">&quot;not supports </span><span class="si">#{</span><span class="n">local_settings</span><span class="o">[</span><span class="s1">&#39;adapter&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># gzip db</span>
</span><span class='line'>      <span class="n">run_locally</span> <span class="s2">&quot;gzip -f </span><span class="si">#{</span><span class="n">local_sql_file_path</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># send the gz file to remote</span>
</span><span class='line'>      <span class="n">upload</span> <span class="n">local_sql_gz_file_path</span><span class="p">,</span> <span class="n">remote_sql_gz_file_path</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># unzip sql</span>
</span><span class='line'>      <span class="n">run</span> <span class="s2">&quot;gunzip </span><span class="si">#{</span><span class="n">remote_sql_gz_file_path</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># import db to remote db</span>
</span><span class='line'>      <span class="c1"># may need to run `RAILS_ENV=production rake db:create` on remote first</span>
</span><span class='line'>      <span class="k">if</span> <span class="n">local_settings</span><span class="o">[</span><span class="s1">&#39;adapter&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s1">&#39;postgresql&#39;</span>
</span><span class='line'>        <span class="n">run</span> <span class="s2">&quot;PGPASSWORD=&#39;</span><span class="si">#{</span><span class="n">remote_settings</span><span class="o">[</span><span class="s1">&#39;password&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&#39; psql -U </span><span class="si">#{</span><span class="n">remote_settings</span><span class="o">[</span><span class="s1">&#39;username&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2"> -d </span><span class="si">#{</span><span class="n">remote_settings</span><span class="o">[</span><span class="s2">&quot;database&quot;</span><span class="o">]</span><span class="si">}</span><span class="s2"> -f </span><span class="si">#{</span><span class="n">remote_sql_file_path</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="k">elsif</span> <span class="n">local_settings</span><span class="o">[</span><span class="s1">&#39;adapter&#39;</span><span class="o">]</span> <span class="o">==</span> <span class="s1">&#39;mysql2&#39;</span>
</span><span class='line'>        <span class="n">run</span> <span class="s2">&quot;mysql -u</span><span class="si">#{</span><span class="n">remote_settings</span><span class="o">[</span><span class="s2">&quot;username&quot;</span><span class="o">]</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="s2">&quot;-p</span><span class="si">#{</span><span class="n">remote_settings</span><span class="o">[</span><span class="s2">&quot;password&quot;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">remote_settings</span><span class="o">[</span><span class="s2">&quot;password&quot;</span><span class="o">]</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">remote_settings</span><span class="o">[</span><span class="s2">&quot;database&quot;</span><span class="o">]</span><span class="si">}</span><span class="s2"> &lt; </span><span class="si">#{</span><span class="n">remote_sql_file_path</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="k">raise</span> <span class="s2">&quot;not supports </span><span class="si">#{</span><span class="n">local_settings</span><span class="o">[</span><span class="s1">&#39;adapter&#39;</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># now that we have the updated production dump file we should use the remote settings to import this db</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">desc</span> <span class="s2">&quot;Mirrors the local shared public directory with the remote copy, doesn&#39;t download symlinks&quot;</span>
</span><span class='line'>    <span class="n">task</span> <span class="ss">:shared_assets</span> <span class="k">do</span>
</span><span class='line'>      <span class="n">run</span> <span class="s2">&quot;cp -R </span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/system </span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/system_back&quot;</span>
</span><span class='line'>      <span class="n">run</span> <span class="s2">&quot;cp -R </span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/public/uploads/ </span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/public/uploads_back&quot;</span>
</span><span class='line'>      <span class="n">run_locally</span><span class="p">(</span><span class="s2">&quot;rsync --recursive --times --rsh=ssh --compress --human-readable --progress public/system </span><span class="si">#{</span><span class="n">user</span><span class="si">}</span><span class="s2">@</span><span class="si">#{</span><span class="n">app_server</span><span class="si">}</span><span class="s2">:</span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">run_locally</span><span class="p">(</span><span class="s2">&quot;rsync --recursive --times --rsh=ssh --compress --human-readable --progress public/uploads/ </span><span class="si">#{</span><span class="n">user</span><span class="si">}</span><span class="s2">@</span><span class="si">#{</span><span class="n">app_server</span><span class="si">}</span><span class="s2">:</span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/public/uploads&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<h3>添加<code>deploy/production.rb</code>,并填写以下内容</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># config/deploy/production.rb</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:app_server</span><span class="p">,</span> <span class="s2">&quot;服务器地址&quot;</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:app_url</span><span class="p">,</span> <span class="s2">&quot;服务器网址&quot;</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:application</span><span class="p">,</span> <span class="n">app_server</span>
</span><span class='line'><span class="n">role</span> <span class="ss">:web</span><span class="p">,</span> <span class="n">app_server</span>
</span><span class='line'><span class="n">role</span> <span class="ss">:app</span><span class="p">,</span> <span class="n">app_server</span>
</span><span class='line'><span class="n">role</span> <span class="ss">:db</span><span class="p">,</span>  <span class="n">app_server</span><span class="p">,</span> <span class="ss">:primary</span> <span class="o">=&gt;</span> <span class="kp">true</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:deploy_to</span><span class="p">,</span> <span class="s2">&quot;/var/www/xxx&quot;</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:user</span><span class="p">,</span> <span class="s2">&quot;deploy&quot;</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:rvm_ruby_string</span><span class="p">,</span> <span class="s2">&quot;ruby-2.2.2&quot;</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:branch</span><span class="p">,</span> <span class="s2">&quot;master&quot;</span>
</span><span class='line'><span class="n">set</span> <span class="ss">:rails_env</span><span class="p">,</span> <span class="s2">&quot;productiono&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>添加<code>database.yml.example</code></h3>

<p><code>config/database.yml</code>文件是不应该被提交到代码库的，我们需要用 config/database.yml.example 来做样本，在部署的时候它会被上传到服务器的 /path_to_your_site/shared/config/ 目录里，然后 SSH 到服务器上修改 username, password, socket 等值（上传的动作是在测试部署里说明）。尤其注意 MySQL socket 的路径在 Mac OS 和 Ubuntu 系统上是不同的。</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># SQLite version 3.x</span>
</span><span class='line'><span class="c1">#   gem install sqlite3</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1">#   Ensure the SQLite 3 gem is defined in your Gemfile</span>
</span><span class='line'><span class="c1">#   gem &#39;sqlite3&#39;</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="ss">default</span><span class="p">:</span> <span class="o">&amp;</span><span class="n">default</span>
</span><span class='line'>  <span class="ss">adapter</span><span class="p">:</span> <span class="n">sqlite3</span>
</span><span class='line'>  <span class="ss">pool</span><span class="p">:</span> <span class="mi">5</span>
</span><span class='line'>  <span class="ss">timeout</span><span class="p">:</span> <span class="mi">5000</span>
</span><span class='line'>
</span><span class='line'><span class="ss">development</span><span class="p">:</span>
</span><span class='line'>  <span class="o">&lt;&lt;</span><span class="p">:</span> <span class="o">*</span><span class="n">default</span>
</span><span class='line'>  <span class="ss">database</span><span class="p">:</span> <span class="n">db</span><span class="o">/</span><span class="n">development</span><span class="o">.</span><span class="n">sqlite3</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Warning: The database defined as &quot;test&quot; will be erased and</span>
</span><span class='line'><span class="c1"># re-generated from your development database when you run &quot;rake&quot;.</span>
</span><span class='line'><span class="c1"># Do not set this db to the same as development or production.</span>
</span><span class='line'><span class="nb">test</span><span class="p">:</span>
</span><span class='line'>  <span class="o">&lt;&lt;</span><span class="p">:</span> <span class="o">*</span><span class="n">default</span>
</span><span class='line'>  <span class="ss">database</span><span class="p">:</span> <span class="n">db</span><span class="o">/</span><span class="nb">test</span><span class="o">.</span><span class="n">sqlite3</span>
</span><span class='line'>
</span><span class='line'><span class="ss">production</span><span class="p">:</span>
</span><span class='line'>  <span class="o">&lt;&lt;</span><span class="p">:</span> <span class="o">*</span><span class="n">default</span>
</span><span class='line'>  <span class="ss">database</span><span class="p">:</span> <span class="n">db</span><span class="o">/</span><span class="n">production</span><span class="o">.</span><span class="n">sqlite3</span>
</span></code></pre></td></tr></table></div></figure>


<h3>为<code>production</code>添加<code>secret_key_base</code></h3>

<p>编辑 config/secrets.yml 文件，添加：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="ss">production</span><span class="p">:</span>
</span><span class='line'>  <span class="ss">secret_key_base</span><span class="p">:</span> <span class="n">a1feaf0cb8501bb41952bbd1df3641ca0c4eed5beb19fcb69bbaaf30b5e11d58872092a84951679f7df622dda2d6bd1b21f98bd2a24b99e096095f003e4ccf90</span>
</span></code></pre></td></tr></table></div></figure>


<p>128位的随机字符串可用 rake secret 命令生成。</p>

<h3>在你的github或者gitlab添加ssh key</h3>

<p>你可以按如下命令来生成sshkey</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>ssh-keygen -t rsa -C <span class="s2">&quot;xxxxx@xxxxx.com&quot;</span>
</span><span class='line'>cat ~/.ssh/id_rsa.pub
</span></code></pre></td></tr></table></div></figure>


<h3>初始化<code>cap</code></h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>cap deploy:setup
</span><span class='line'>cap deploy:check
</span><span class='line'>cap deploy:update
</span><span class='line'>cap db:create
</span><span class='line'>cap deploy:migrate
</span></code></pre></td></tr></table></div></figure>


<h3>以后就可以通过跑以下命令，部署你的应用了</h3>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>cap deploy:migrations 或者 cap deploy
</span></code></pre></td></tr></table></div></figure>


<h3>修改 Nginx 配置</h3>

<p>删除原有的默认网站配置：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>rm /etc/nginx/sites-enabled/default
</span></code></pre></td></tr></table></div></figure>


<p>新建网站配置：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>touch /etc/nginx/sites-enabled/example.com.conf
</span></code></pre></td></tr></table></div></figure>


<p>编辑<code>/etc/nginx/sites-enabled/example.com.conf</code>，写入以下内容：</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'>server <span class="o">{</span>
</span><span class='line'>    listen <span class="m">80</span> default<span class="p">;</span>
</span><span class='line'>    server_name example.com<span class="p">;</span> <span class="c"># 这里填写你真实域名</span>
</span><span class='line'>    root /var/www/example.com/current/public<span class="p">;</span>
</span><span class='line'>    passenger_enabled on<span class="p">;</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>重启Nginx</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='sh'><span class='line'><span class="nv">$ </span>sudo service nginx restart
</span></code></pre></td></tr></table></div></figure>


<h2>完成</h2>

<p>在浏览器打开服务器的 IP 地址或域名，可以看到Nginx已经启动</p>

<p>ref: <a href="http://stackoverflow.com/questions/17413526/nginx-missing-sites-available-directory">http://stackoverflow.com/questions/17413526/nginx-missing-sites-available-directory</a></p>

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/blog/2016/03/15/centos-shang-shi-yong-nginx-passenger-bu-shu-ruby-on-rails//index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/11/06/web-service-jian-dan-shi-yong/">
		
			WebService 简单使用</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


 November 6, 2015</div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/soap/'>soap</a>, <a class='category' href='/blog/categories/webservice/'>webservice</a>


</div>
    </div>
		<h1>WebService 简单使用</h1>

<p>标签（空格分隔）： 未分类</p>

<hr />

<h2>什么是Web Services？</h2>

<p> Web Services 是独立的（self-contained）并可自我描述
  - Web Services 可通过使用UDDI来发现
  - Web Services 可被其他应用程序使用
  - XML 是 Web Services 的基础</p>

<h2>Web services 平台的元素</h2>

<ul>
<li>SOAP (简易对象访问协议)</li>
<li>UDDI (通用描述、发现及整合)</li>
<li>WSDL (Web services 描述语言)</li>
</ul>


<h3>什么是 SOAP？</h3>

<blockquote><p>基本的 Web services 平台是 XML + HTTP。</p></blockquote>

<ul>
<li>SOAP 指简易对象访问协议</li>
<li>SOAP 是一种通信协议</li>
<li>SOAP 用于应用程序之间的通信</li>
<li>SOAP 是一种用于发送消息的格式</li>
<li>SOAP 被设计用来通过因特网进行通信</li>
<li>SOAP 独立于平台</li>
<li>SOAP 独立于语言</li>
<li>SOAP 基于 XML</li>
<li>SOAP 很简单并可扩展</li>
<li>SOAP 允许您绕过防火墙</li>
<li>SOAP 将作为 W3C 标准来发展</li>
</ul>


<h3>什么是 WSDL?</h3>

<blockquote><p>WSDL 是基于 XML 的用于描述 Web Services 以及如何访问 Web Services 的语言。</p></blockquote>

<ul>
<li>WSDL 指网络服务描述语言</li>
<li>WSDL 使用 XML 编写</li>
<li>WSDL 是一种 XML 文档</li>
<li>WSDL 用于描述网络服务</li>
<li>WSDL 也可用于定位网络服务</li>
<li>WSDL 还不是 W3C 标准</li>
<li><a href="http://www.thomas-bayer.com/axis2/services/BLZService?wsdl">wsdl例子</a></li>
</ul>


<h3>什么是UDDI？</h3>

<ul>
<li>UDDI 是一种目录服务，通过它，企业可注册并搜索 Web services。</li>
<li>UDDI 指通用的描述、发现以及整合（Universal Description, Discovery and Integration）。</li>
<li>UDDI 是一种用于存储有关 web services 的信息的目录。</li>
<li>UDDI 是一种由 WSDL 描述的网络服务接口目录。</li>
<li>UDDI 经由 SOAP 进行通迅。</li>
<li>UDDI 被构建于 Microsoft .NET 平台之中。</li>
</ul>


<h3>调试工具</h3>

<ul>
<li><a href="http://www.soapui.org/downloads/soapui/open-source.html">SOAP UI 工具</a></li>
<li><a href="https://docs.awspaas.com/reference-guide/aws-paas-api-guide/soap/cxf.html">使用CXF客户端</a></li>
<li><a href="https://docs.awspaas.com/reference-guide/aws-paas-api-guide/soap/java_client.html">使用JDK客户端</a></li>
</ul>


<h3>SOAP和HTTP区别</h3>

<ul>
<li>请求消息格式不同</li>
<li>响应消息格式不同</li>
<li>安全机制不同</li>
<li>客户端调用方式不同</li>
<li>并发处理能力的不同</li>
</ul>


<h3>在Rails下如何调用SOAP接口</h3>

<p>官方文档</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1"># create a client for the service</span>
</span><span class='line'><span class="n">client</span> <span class="o">=</span> <span class="no">Savon</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="ss">wsdl</span><span class="p">:</span> <span class="s1">&#39;http://service.example.com?wsdl&#39;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">client</span><span class="o">.</span><span class="n">operations</span>
</span><span class='line'><span class="c1"># =&gt; [:find_user, :list_users]</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># call the &#39;findUser&#39; operation</span>
</span><span class='line'><span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="ss">:find_user</span><span class="p">,</span> <span class="ss">message</span><span class="p">:</span> <span class="p">{</span> <span class="nb">id</span><span class="p">:</span> <span class="mi">42</span> <span class="p">})</span>
</span><span class='line'>
</span><span class='line'><span class="n">response</span><span class="o">.</span><span class="n">body</span>
</span><span class='line'><span class="c1"># =&gt; { find_user_response: { id: 42, name: &#39;Hoff&#39; } }</span>
</span></code></pre></td></tr></table></div></figure>


<p>实际例子</p>

<figure class='code'><figcaption><span></span></figcaption><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="k">class</span> <span class="nc">SoapWithSavon</span>
</span><span class='line'>  <span class="k">class</span> <span class="o">&lt;&lt;</span> <span class="nb">self</span>
</span><span class='line'>    <span class="c1"># TODO: should use settin</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">client</span>
</span><span class='line'>      <span class="vi">@client</span> <span class="o">||=</span> <span class="no">Savon</span><span class="o">.</span><span class="n">client</span> <span class="k">do</span>
</span><span class='line'>        <span class="c1"># WSDL 接口</span>
</span><span class='line'>        <span class="n">wsdl</span> <span class="s2">&quot;http://192.168.0.22:8000/sap/bc/srt/wsdl/srvc_5618AD468DEB07E0E1008000C0A80016/wsdl11/allinone/ws_policy/document?sap-client=300&quot;</span>
</span><span class='line'>        <span class="c1"># 用户验证</span>
</span><span class='line'>        <span class="n">basic_auth</span> <span class="s2">&quot;CRMINTERFACE&quot;</span><span class="p">,</span> <span class="s2">&quot;123456&quot;</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># 默认同步昨天的设备数据</span>
</span><span class='line'>    <span class="k">def</span> <span class="nf">get_devices</span> <span class="p">(</span><span class="n">start_at</span> <span class="o">=</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">,</span> <span class="n">end_at</span> <span class="o">=</span> <span class="mi">1</span><span class="o">.</span><span class="n">day</span><span class="o">.</span><span class="n">ago</span><span class="p">)</span>
</span><span class='line'>      <span class="n">start_at_format</span> <span class="o">=</span> <span class="n">start_at</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-%d&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">end_at_format</span> <span class="o">=</span> <span class="n">end_at</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-%d&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="n">response</span> <span class="o">=</span> <span class="n">call_and_fail_gracefully</span><span class="p">(</span><span class="ss">:z_wl_material</span><span class="p">,</span> <span class="ss">:message</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="s2">&quot;EAssetMatnr&quot;</span> <span class="o">=&gt;</span> <span class="p">{},</span> <span class="s2">&quot;ImUdate1&quot;</span> <span class="o">=&gt;</span> <span class="n">start_at_format</span><span class="p">,</span> <span class="s2">&quot;ImUdate2&quot;</span> <span class="o">=&gt;</span> <span class="n">end_at_format</span>  <span class="p">})</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="o">[</span><span class="ss">:z_wl_material_response</span><span class="o">][</span><span class="ss">:e_msgty</span><span class="o">]</span> <span class="o">==</span> <span class="s2">&quot;E&quot;</span>
</span><span class='line'>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="o">[</span><span class="ss">:z_wl_material_response</span><span class="o">][</span><span class="ss">:e_ermsg</span><span class="o">]</span>
</span><span class='line'>        <span class="o">[]</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="n">response</span><span class="o">.</span><span class="n">body</span><span class="o">[</span><span class="ss">:z_wl_material_response</span><span class="o">][</span><span class="ss">:e_asset_matnr</span><span class="o">][</span><span class="ss">:item</span><span class="o">]</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">logger</span>
</span><span class='line'>      <span class="vc">@@logger</span> <span class="o">||=</span> <span class="no">Logger</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="s1">&#39;./log/soap_with_savon.log&#39;</span><span class="p">)</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="nf">call_and_fail_gracefully</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>      <span class="n">client</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
</span><span class='line'>    <span class="k">rescue</span> <span class="no">Savon</span><span class="o">::</span><span class="no">SOAPFault</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>      <span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="n">e</span>
</span><span class='line'>    <span class="k">rescue</span> <span class="no">Savon</span><span class="o">::</span><span class="no">HTTPError</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>      <span class="c1"># HTTP Error</span>
</span><span class='line'>      <span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="n">e</span>
</span><span class='line'>    <span class="k">rescue</span> <span class="no">Savon</span><span class="o">::</span><span class="no">InvalidResponseError</span> <span class="o">=&gt;</span> <span class="n">e</span>
</span><span class='line'>      <span class="c1"># InvalidResponseError</span>
</span><span class='line'>      <span class="n">logger</span><span class="o">.</span><span class="n">info</span> <span class="n">e</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span>
</span></code></pre></td></tr></table></div></figure>


<p>参考文档
<a href="https://github.com/savonrb/savon">savon</a>
<a href="https://docs.awspaas.com/reference-guide/aws-paas-api-guide/index.html">AWS PaaS API参考指南</a></p>

		
		
	</div>

<div class="meta">
	
		<span class="comments"><a href="/blog/2015/11/06/web-service-jian-dan-shi-yong//index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/08/22/using-alias-in-linux-slash-mac/">
		
			Using Alias in Linux/mac</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


 August 22, 2015</div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/alias/'>alias</a>, <a class='category' href='/blog/categories/linux/'>linux</a>, <a class='category' href='/blog/categories/mac/'>mac</a>


</div>
    </div>
		<p>相信大部分的Linux用户都用过alias去自定义自己的快捷命令,今天整理一下自己常用的alias(原来的alias就是一坨<del>(>_&lt;)</del> )</p>


		
		<a href="/blog/2015/08/22/using-alias-in-linux-slash-mac/" class="more-link">Read on</a>
	</div>

<div class="meta">
	
		<span class="comments"><a href="/blog/2015/08/22/using-alias-in-linux-slash-mac//index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/07/21/building-mobile-applications-with-rails-and-ionic/">
		
			Building Mobile Applications With Rails and Ionic</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


 July 21, 2015</div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/ionic/'>ionic</a>


</div>
    </div>
		<p>本文介绍如何在rails上面开发ionic.</p>


		
		<a href="/blog/2015/07/21/building-mobile-applications-with-rails-and-ionic/" class="more-link">Read on</a>
	</div>

<div class="meta">
	
		<span class="comments"><a href="/blog/2015/07/21/building-mobile-applications-with-rails-and-ionic//index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/07/06/google-map-with-ionic/">
		
			Google Map With Ionic</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


 July 6, 2015</div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/ionic/'>ionic</a>, <a class='category' href='/blog/categories/rails/'>rails</a>


</div>
    </div>
		<p>本文介绍如何在ionic添加google map.</p>


		
		<a href="/blog/2015/07/06/google-map-with-ionic/" class="more-link">Read on</a>
	</div>

<div class="meta">
	
		<span class="comments"><a href="/blog/2015/07/06/google-map-with-ionic//index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/07/05/li-jie-activesupport-concern/">
		
			理解 ActiveSupport::Concern</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


 July 5, 2015</div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/rails/'>rails</a>


</div>
    </div>
		<p>分享一下自己阅读ActiveSupport::Concern源码的过程，希望和大家一起学习，错误之处，还请指出</p>


		
		<a href="/blog/2015/07/05/li-jie-activesupport-concern/" class="more-link">Read on</a>
	</div>

<div class="meta">
	
		<span class="comments"><a href="/blog/2015/07/05/li-jie-activesupport-concern//index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2015/07/05/rails-scopes-yu-jia-zai/">
		
			Rails Scopes 预加载</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


 July 5, 2015</div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/rails/'>rails</a>


</div>
    </div>
		<p>前几天在<a href="http://rubyweekly.com/">rubyweekly</a>里面看到一篇文章，感觉写得不错。拿出来分享一下。<a href="http://www.justinweiss.com/%0Ablog/2015/06/23/how-to-preload-rails-scopes/?utm_source=rubyweekly&amp;utm_medium=email">原文</a>更精彩</p>


		
		<a href="/blog/2015/07/05/rails-scopes-yu-jia-zai/" class="more-link">Read on</a>
	</div>

<div class="meta">
	
		<span class="comments"><a href="/blog/2015/07/05/rails-scopes-yu-jia-zai//index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2014/05/30/oauth2-dot-0-shi-yong-ji-qiao/">
		
			Oauth2.0</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


 May 30, 2014</div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/ouath2-dot-0/'>ouath2.0</a>


</div>
    </div>
		<p>Oauth2.0 验证流程简单介绍(使用doorkeeper)</p>


		
		<a href="/blog/2014/05/30/oauth2-dot-0-shi-yong-ji-qiao/" class="more-link">Read on</a>
	</div>

<div class="meta">
	
		<span class="comments"><a href="/blog/2014/05/30/oauth2-dot-0-shi-yong-ji-qiao//index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2013/10/27/rang-zshwei-ni-de-terminaldai-lai-bu-%5B%3F%5D-yang-de-gan-jue/">
		
			让zsh为你的Terminal带来不一样的感觉</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


 October 27, 2013</div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/mac/'>mac</a>


</div>
    </div>
		<p>刚接触Mac,发现有zsh这一神器</p>


		
		<a href="/blog/2013/10/27/rang-zshwei-ni-de-terminaldai-lai-bu-%5B%3F%5D-yang-de-gan-jue/" class="more-link">Read on</a>
	</div>

<div class="meta">
	
		<span class="comments"><a href="/blog/2013/10/27/rang-zshwei-ni-de-terminaldai-lai-bu-%5B%3F%5D-yang-de-gan-jue//index.html#disqus_thread">Comments</a></span>
	
</div>
</article>


    <article class="post">
	<h2 class="title">
		
		<a href="/blog/2013/10/26/cong-vimdao-sublime-text/">
		
			从Vim到Sublime Text</a>
	</h2>
    <div class="entry-content">
    <div class="meta">
      <div class="date">Published on: 








  


 October 26, 2013</div>
      <div class="tags">Tags: 


	<a class='category' href='/blog/categories/sublime/'>sublime</a>, <a class='category' href='/blog/categories/text/'>text</a>


</div>
    </div>
		<p>讲述我从vim转化到sublime text的过程</p>


		
		<a href="/blog/2013/10/26/cong-vimdao-sublime-text/" class="more-link">Read on</a>
	</div>

<div class="meta">
	
		<span class="comments"><a href="/blog/2013/10/26/cong-vimdao-sublime-text//index.html#disqus_thread">Comments</a></span>
	
</div>
</article>

<nav id="pagenavi">
    
    
        <a href="2" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav>

    </div>
    <footer id="footer">
    <div style="display:inline">
    Copyright &copy; 2016

    Justin-lu
. Powered by <a href="http://octopress.org">Octopress</a> | 
    Theme <a href="http://github.com/panks/fabric">fabric</a> by <a href="http://panks.me">Pankaj Kumar</a>
</div>


    </footer>
    <script src="/javascripts/fabric.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->


<script type="text/javascript">
      var disqus_shortname = 'justin-lu-blog';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





<!-- end toload --> 
</div>
</div>
<script src="/javascripts/jquery.ui.totop.js" type="text/javascript"></script>
<script type="text/javascript">
/*<![CDATA[*/
;(function($){$().UItoTop({easingType:'easeOutCirc'});})(jQuery); 
/*]]>*/
</script><!-- remove it to remove the scroll to top button -->
</body>
</html>
